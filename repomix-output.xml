This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  api/
    export/
      route.ts
  auth/
    callback/
      route.ts
    forgot-password/
      page.tsx
    login/
      page.tsx
    signup/
      page.tsx
    update-password/
      page.tsx
  completed/
    page.tsx
  components/
    DeleteListButton.tsx
    Header.tsx
    LayoutWrapper.tsx
    ListSwitcher.tsx
    ManualReprocessButton.tsx
    QuickCompleteButton.tsx
  dashboard/
    page.tsx
  do-now/
    page.tsx
  master-list/
    page.tsx
  projects/
    [id]/
      page.tsx
    page.tsx
  settings/
    lists/
      page.tsx
    test/
      page.tsx
    page.tsx
  globals.css
  layout.tsx
  page.tsx
components/
  AddItemForm.tsx
  CompletedFilters.tsx
  ExportDatabaseForm.tsx
  ImportDatabaseForm.tsx
  ProjectActions.tsx
  ProjectDetailClient.tsx
  ProjectItemsSection.tsx
  ResetAppForm.tsx
lib/
  actions/
    auth.ts
    completed.ts
    dashboard.ts
    items.ts
    lists.ts
    masterlist.ts
    profile.ts
    project-items.ts
    projects.ts
    reprocess.ts
    settings.ts
    tasks.ts
  supabase/
    admin.ts
    client.ts
    middleware.ts
    server.ts
  utils/
    index.ts
    list-context.ts
    masterlist.ts
types/
  database.ts
  index.ts
.eslintrc.json
.gitignore
.repomixignore
DATABASE_SCHEMA.sql
middleware.ts
next.config.js
package.json
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/api/export/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { exportDatabase } from '@/lib/actions/settings';

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient();
    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const { userId } = body;

    if (user.id !== userId) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 403 }
      );
    }

    const result = await exportDatabase(userId);

    if (!result.success) {
      return NextResponse.json(
        { error: result.error },
        { status: 500 }
      );
    }

    return NextResponse.json(result);
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Export failed' },
      { status: 500 }
    );
  }
}
</file>

<file path="app/auth/callback/route.ts">
import { createServerClient } from '@supabase/ssr';
import { NextResponse } from 'next/server';
import { cookies } from 'next/headers';

export async function GET(request: Request) {
  const requestUrl = new URL(request.url);
  const code = requestUrl.searchParams.get('code');
  const token_hash = requestUrl.searchParams.get('token_hash');
  const type = requestUrl.searchParams.get('type');
  const next = requestUrl.searchParams.get('next') || '/auth/update-password';

  const cookieStore = await cookies();
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch (error) {
            // Handle cookie errors
          }
        },
      }
    }
  );

  if (code) {
    const { error } = await supabase.auth.exchangeCodeForSession(code);
    
    if (error) {
      return NextResponse.redirect(
        `${requestUrl.origin}/auth/forgot-password?error=${encodeURIComponent(error.message)}`
      );
    }

    return NextResponse.redirect(`${requestUrl.origin}${next}`);
  }

  if (token_hash && type === 'recovery') {
    const { error } = await supabase.auth.verifyOtp({
      token_hash,
      type: 'recovery',
    });

    if (error) {
      return NextResponse.redirect(
        `${requestUrl.origin}/auth/forgot-password?error=${encodeURIComponent(error.message)}`
      );
    }

    return NextResponse.redirect(`${requestUrl.origin}${next}`);
  }

  return NextResponse.redirect(`${requestUrl.origin}/auth/forgot-password?error=${encodeURIComponent('Invalid reset link')}`);
}
</file>

<file path="app/auth/forgot-password/page.tsx">
import { requestPasswordReset } from '@/lib/actions/auth';

export default async function ForgotPasswordPage({
  searchParams,
}: {
  searchParams: Promise<{ success?: string; error?: string }>;
}) {
  const params = await searchParams;
  
  return (
    <div className="form-container">
      <h1>Reset Password</h1>
      <p style={{ marginBottom: '1.5rem', color: '#666' }}>
        Enter your email address and we&apos;ll send you a link to reset your password.
      </p>
      
      {params.success && (
        <div style={{ 
          padding: '1rem', 
          marginBottom: '1rem', 
          backgroundColor: '#e8f5e9', 
          border: '1px solid #4caf50', 
          borderRadius: '4px', 
          color: '#2e7d32' 
        }}>
          {params.success}
        </div>
      )}
      
      {params.error && (
        <div style={{ 
          padding: '1rem', 
          marginBottom: '1rem', 
          backgroundColor: '#fee', 
          border: '1px solid #fcc', 
          borderRadius: '4px', 
          color: '#c33' 
        }}>
          {params.error}
        </div>
      )}
      
      <form>
        <div className="form-group">
          <label htmlFor="email">Email</label>
          <input 
            id="email" 
            name="email" 
            type="email" 
            required 
            placeholder="Enter your email address" 
          />
        </div>
        
        <div className="form-actions">
          <button type="submit" formAction={requestPasswordReset} className="btn-primary">
            Send Reset Link
          </button>
        </div>
      </form>
      
      <div style={{ marginTop: '1rem', textAlign: 'center' }}>
        <a href="/auth/login">Back to Login</a>
      </div>
    </div>
  );
}
</file>

<file path="app/auth/login/page.tsx">
import { signIn } from '@/lib/actions/auth';

export default async function LoginPage({
  searchParams,
}: {
  searchParams: Promise<{ error?: string; success?: string }>;
}) {
  const params = await searchParams;
  
  return (
    <div className="form-container">
      <h1>Login</h1>
      {params.success && (
        <div style={{ padding: '1rem', marginBottom: '1rem', backgroundColor: '#e8f5e9', border: '1px solid #4caf50', borderRadius: '4px', color: '#2e7d32' }}>
          {params.success}
        </div>
      )}
      {params.error && (
        <div style={{ padding: '1rem', marginBottom: '1rem', backgroundColor: '#fee', border: '1px solid #fcc', borderRadius: '4px', color: '#c33' }}>
          {params.error}
        </div>
      )}
      <form>
        <div className="form-group">
          <label htmlFor="email">Email</label>
          <input id="email" name="email" type="email" required placeholder="Enter your email" />
        </div>
        <div className="form-group">
          <label htmlFor="password">Password</label>
          <input id="password" name="password" type="password" required placeholder="Enter your password" />
        </div>
        <div style={{ marginBottom: '1rem', textAlign: 'right' }}>
          <a href="/auth/forgot-password" style={{ fontSize: '0.9rem', color: '#666' }}>Forgot Password?</a>
        </div>
        <div className="form-actions">
          <button type="submit" formAction={signIn} className="btn-primary">Sign In</button>
        </div>
      </form>
      <div style={{ marginTop: '1rem', textAlign: 'center' }}>
        <a href="/auth/signup">Do not have an account? Sign up</a>
      </div>
    </div>
  );
}
</file>

<file path="app/auth/signup/page.tsx">
import { signUp } from '@/lib/actions/auth';

export default async function SignupPage({
  searchParams,
}: {
  searchParams: Promise<{ error?: string }>;
}) {
  const params = await searchParams;
  
  return (
    <div className="form-container">
      <h1>Sign Up</h1>
      {params.error && (
        <div style={{ padding: '1rem', marginBottom: '1rem', backgroundColor: '#fee', border: '1px solid #fcc', borderRadius: '4px', color: '#c33' }}>
          {params.error}
        </div>
      )}
      <form>
        <div className="form-group">
          <label htmlFor="email">Email</label>
          <input id="email" name="email" type="email" required placeholder="Enter your email" />
        </div>
        <div className="form-group">
          <label htmlFor="password">Password</label>
          <input id="password" name="password" type="password" required placeholder="Enter your password" />
        </div>
        <div className="form-group">
          <label htmlFor="username">Username</label>
          <input id="username" name="username" type="text" placeholder="Choose a username" />
        </div>
        <div className="form-group">
          <label htmlFor="first_name">First Name</label>
          <input id="first_name" name="first_name" type="text" placeholder="Enter your first name" />
        </div>
        <div className="form-group">
          <label htmlFor="last_name">Last Name</label>
          <input id="last_name" name="last_name" type="text" placeholder="Enter your last name" />
        </div>
        <div className="form-group">
          <label htmlFor="birthdate">Birthdate</label>
          <input id="birthdate" name="birthdate" type="date" />
        </div>
        <div className="form-group">
          <label htmlFor="gender">Gender</label>
          <select id="gender" name="gender">
            <option value="">Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div className="form-actions">
          <button type="submit" formAction={signUp} className="btn-primary">Sign Up</button>
        </div>
      </form>
      <div style={{ marginTop: '1rem', textAlign: 'center' }}>
        <a href="/auth/login">Already have an account? Sign in</a>
      </div>
    </div>
  );
}
</file>

<file path="app/auth/update-password/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { createClient } from '@/lib/supabase/client';
import { useRouter } from 'next/navigation';

export default function UpdatePasswordPage() {
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [sessionChecked, setSessionChecked] = useState(false);
  const router = useRouter();
  const supabase = createClient();

  useEffect(() => {
    const checkSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        router.push('/auth/forgot-password?error=' + encodeURIComponent('Password reset link is invalid or has expired. Please request a new one.'));
      } else {
        setSessionChecked(true);
      }
    };

    checkSession();
  }, [router, supabase.auth]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    if (!password || !confirmPassword) {
      setError('All fields are required');
      setLoading(false);
      return;
    }

    if (password !== confirmPassword) {
      setError('Passwords do not match');
      setLoading(false);
      return;
    }

    if (password.length < 6) {
      setError('Password must be at least 6 characters');
      setLoading(false);
      return;
    }

    const { error: updateError } = await supabase.auth.updateUser({
      password: password,
    });

    if (updateError) {
      setError(updateError.message);
      setLoading(false);
      return;
    }

    await supabase.auth.signOut();
    router.push('/auth/login?success=' + encodeURIComponent('Password updated successfully. Please login with your new password.'));
  };

  if (!sessionChecked) {
    return (
      <div className="form-container">
        <h1>Loading...</h1>
        <p>Please wait while we verify your reset link...</p>
      </div>
    );
  }

  return (
    <div className="form-container">
      <h1>Set New Password</h1>
      <p style={{ marginBottom: '1.5rem', color: '#666' }}>
        Enter your new password below.
      </p>
      
      {error && (
        <div style={{ 
          padding: '1rem', 
          marginBottom: '1rem', 
          backgroundColor: '#fee', 
          border: '1px solid #fcc', 
          borderRadius: '4px', 
          color: '#c33' 
        }}>
          {error}
        </div>
      )}
      
      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label htmlFor="password">New Password</label>
          <input 
            id="password" 
            name="password" 
            type="password" 
            required 
            minLength={6}
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Enter new password (min 6 characters)"
            disabled={loading}
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="confirmPassword">Confirm New Password</label>
          <input 
            id="confirmPassword" 
            name="confirmPassword" 
            type="password" 
            required 
            minLength={6}
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            placeholder="Confirm new password"
            disabled={loading}
          />
        </div>
        
        <div className="form-actions">
          <button type="submit" className="btn-primary" disabled={loading}>
            {loading ? 'Updating...' : 'Update Password'}
          </button>
        </div>
      </form>
      
      <div style={{ marginTop: '1rem', textAlign: 'center' }}>
        <a href="/auth/login">Back to Login</a>
      </div>
    </div>
  );
}
</file>

<file path="app/completed/page.tsx">
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getCompletedErrands, getCompletedProjects, getCompletedProjectItems } from '@/lib/actions/completed';
import CompletedFilters from '@/components/CompletedFilters';
import ProjectItemsSection from '@/components/ProjectItemsSection';

function formatDateTime(dateString: string | null) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${month}/${day}/${year} ${hours}:${minutes}`;
}

function formatDate(dateString: string | null) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();
  return `${month}/${day}/${year}`;
}

export default async function CompletedPage({
  searchParams,
}: {
  searchParams: Promise<{ dateFilter?: string; typeFilter?: string }>;
}) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  const query = await searchParams;
  const dateFilter = query.dateFilter || 'all';
  const typeFilter = query.typeFilter || 'all';

  const { data: errands } = await getCompletedErrands(
    user.id,
    dateFilter !== 'all' ? dateFilter : undefined
  );

  const { data: projects } = await getCompletedProjects(user.id);

  const { data: projectItems } = await getCompletedProjectItems(
    user.id,
    undefined,
    dateFilter !== 'all' ? dateFilter : undefined
  );

  const showErrands = typeFilter === 'all' || typeFilter === 'errands';
  const showProjectItems = typeFilter === 'all' || typeFilter === 'projects';

  return (
    <div className="page-container">
      <div className="page-header">
        <h1 className="page-title">Completed Items</h1>
        <p className="page-subtitle">View all your completed tasks and projects</p>
      </div>

      <CompletedFilters currentDateFilter={dateFilter} currentTypeFilter={typeFilter} />

      {showErrands && (
        <section className="section">
          <div className="section-header">
            <h2 className="section-title">Completed Errands</h2>
          </div>
          <p style={{ color: '#666', marginBottom: '1rem' }}>
            Total Completed Errands: {errands?.length || 0}
          </p>
          {!errands || errands.length === 0 ? (
            <div className="table-empty">
              <p>No completed errands yet</p>
            </div>
          ) : (
            <div className="table-container">
              <table className="data-table">
                <thead>
                  <tr>
                    <th>Item Name</th>
                    <th>Date Completed</th>
                  </tr>
                </thead>
                <tbody>
                  {errands.map((item: any) => (
                    <tr key={item.id}>
                      <td>{item.name}</td>
                      <td>{formatDateTime(item.date_completed)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>
      )}

      {showProjectItems && (
        <section className="section">
          <div className="section-header">
            <h2 className="section-title">Completed Projects</h2>
          </div>
          <p style={{ color: '#666', marginBottom: '1rem' }}>
            Total Completed Projects: {projects?.length || 0}
          </p>
          {!projects || projects.length === 0 ? (
            <div className="table-empty">
              <p>No completed projects yet</p>
            </div>
          ) : (
            <div className="table-container">
              <table className="data-table">
                <thead>
                  <tr>
                    <th>Project Name</th>
                    <th>Priority</th>
                    <th>Date Created</th>
                    <th>Total Items</th>
                  </tr>
                </thead>
                <tbody>
                  {projects.map((project: any) => (
                    <tr key={project.id}>
                      <td>{project.name}</td>
                      <td>{project.priority}</td>
                      <td>{formatDate(project.created_at)}</td>
                      <td>{project.itemCount}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>
      )}

      {showProjectItems && (
        <section className="section">
          <div className="section-header">
            <h2 className="section-title">Completed Project Items</h2>
          </div>
          {!projectItems || projectItems.length === 0 ? (
            <div className="table-empty">
              <p>No completed project items yet</p>
            </div>
          ) : (
            <ProjectItemsSection projectGroups={projectItems as any} />
          )}
        </section>
      )}
    </div>
  );
}
</file>

<file path="app/components/DeleteListButton.tsx">
'use client';

interface DeleteListButtonProps {
  listId: string;
  onDelete: (formData: FormData) => Promise<void>;
}

export default function DeleteListButton({ listId, onDelete }: DeleteListButtonProps) {
  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    if (!confirm('Are you sure you want to delete this list? All items in this list will be permanently deleted.')) {
      e.preventDefault();
    }
  };

  return (
    <form style={{ 
      display: 'inline-block',
      padding: 0,
      margin: 0,
      background: 'transparent',
      boxShadow: 'none',
      border: 'none'
    }}>
      <input type="hidden" name="listId" value={listId} />
      <button
        type="submit"
        formAction={onDelete}
        className="btn-sm btn-danger"
        onClick={handleClick}
        style={{ margin: 0 }}
      >
        Delete
      </button>
    </form>
  );
}
</file>

<file path="app/components/Header.tsx">
'use client';

import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { signOut } from '@/lib/actions/auth';
import { setCurrentListId } from '@/lib/actions/lists';
import ListSwitcher from './ListSwitcher';
import type { List } from '@/types';

interface HeaderProps {
  firstName: string;
  showMasterList: boolean;
  lists: List[];
  currentListId: string | null;
}

export default function Header({ firstName, showMasterList, lists, currentListId }: HeaderProps) {
  const pathname = usePathname();
  const router = useRouter();

  const isActive = (path: string) => pathname === path;

  const handleListSwitch = async (listId: string) => {
    await setCurrentListId(listId);
    router.refresh();
  };

  return (
    <header className="app-header">
      <div className="header-container">
        <div className="header-left">
        <nav className="header-nav">
          <Link href="/dashboard" className={isActive('/dashboard') ? 'active' : ''}>
            Dashboard
          </Link>
          <Link href="/do-now" className={isActive('/do-now') ? 'active' : ''}>
            Do Now
          </Link>
          <Link href="/projects" className={isActive('/projects') || pathname.startsWith('/projects/') ? 'active' : ''}>
            Projects
          </Link>
          <Link href="/completed" className={isActive('/completed') ? 'active' : ''}>
            Completed
          </Link>
          {showMasterList && (
            <Link href="/master-list" className={isActive('/master-list') ? 'active' : ''}>
              Master List
            </Link>
          )}
          <Link href="/settings" className={isActive('/settings') ? 'active' : ''}>
            Settings
          </Link>
        </nav>
          {lists.length > 0 && (
            <div className="header-list-switcher">
              <ListSwitcher
                lists={lists}
                currentListId={currentListId}
                onSwitch={handleListSwitch}
              />
            </div>
          )}
        </div>
        <div className="header-user">
          <span className="user-welcome">Welcome, {firstName}</span>
          <form action={signOut} style={{ display: 'inline', margin: 0, padding: 0 }}>
            <button type="submit" className="logout-btn">Logout</button>
          </form>
        </div>
      </div>
    </header>
  );
}
</file>

<file path="app/components/LayoutWrapper.tsx">
import { createClient } from '@/lib/supabase/server';
import { getProfile } from '@/lib/actions/profile';
import { getLists, getCurrentListId, ensureUserHasDefaultList } from '@/lib/actions/lists';
import Header from './Header';

export default async function LayoutWrapper({
  children,
  pathname,
}: {
  children: React.ReactNode;
  pathname: string;
}) {
  const isAuthPage = pathname.startsWith('/auth');

  if (isAuthPage) {
    return <div className="page-content">{children}</div>;
  }

  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return <div className="page-content">{children}</div>;
  }

  const { data: profile } = await getProfile();
  
  await ensureUserHasDefaultList();
  
  const { data: lists } = await getLists();
  const currentListId = await getCurrentListId();

  return (
    <>
      <Header
        firstName={profile?.first_name || 'User'}
        showMasterList={profile?.show_master_list || false}
        lists={lists || []}
        currentListId={currentListId}
      />
      <div className="page-content page-with-header">{children}</div>
    </>
  );
}
</file>

<file path="app/components/ListSwitcher.tsx">
'use client';

import { useState } from 'react';
import type { List } from '@/types';

interface ListSwitcherProps {
  lists: List[];
  currentListId: string | null;
  onSwitch: (listId: string) => void;
}

export default function ListSwitcher({ lists, currentListId, onSwitch }: ListSwitcherProps) {
  const [isOpen, setIsOpen] = useState(false);

  const currentList = lists.find(l => l.id === currentListId);

  const handleSelect = (listId: string) => {
    onSwitch(listId);
    setIsOpen(false);
  };

  if (lists.length === 0) {
    return null;
  }

  return (
    <div className="elephant-list-switcher">
      <button
        type="button"
        className="elephant-list-switcher-button"
        onClick={() => setIsOpen(!isOpen)}
        aria-expanded={isOpen}
        aria-haspopup="true"
      >
        <span className="elephant-list-switcher-label">
          {currentList?.name || 'Select List'}
        </span>
        <svg
          className="elephant-list-switcher-icon"
          width="16"
          height="16"
          viewBox="0 0 16 16"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M4 6L8 10L12 6"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
        </svg>
      </button>

      {isOpen && (
        <>
          <div
            className="elephant-list-switcher-overlay"
            onClick={() => setIsOpen(false)}
          />
          <div className="elephant-list-switcher-dropdown">
            {lists.map((list) => (
              <button
                key={list.id}
                type="button"
                className={`elephant-list-switcher-item ${
                  list.id === currentListId ? 'active' : ''
                }`}
                onClick={() => handleSelect(list.id)}
              >
                <span className="elephant-list-switcher-item-name">{list.name}</span>
                {list.is_default && (
                  <span className="elephant-list-switcher-item-badge">Default</span>
                )}
                {list.id === currentListId && (
                  <svg
                    className="elephant-list-switcher-item-check"
                    width="16"
                    height="16"
                    viewBox="0 0 16 16"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M13 4L6 11L3 8"
                      stroke="currentColor"
                      strokeWidth="2"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                  </svg>
                )}
              </button>
            ))}
          </div>
        </>
      )}

      <style jsx>{`
        .elephant-list-switcher {
          position: relative;
          display: inline-block;
        }

        .elephant-list-switcher-button {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 1rem;
          background: transparent;
          border: none;
          cursor: pointer;
          font-size: 0.95rem;
          font-weight: 500;
          color: #555;
          transition: color 0.2s;
          border-radius: 4px;
        }

        .elephant-list-switcher-button:hover {
          color: #0066cc;
          background: rgba(0, 102, 204, 0.05);
        }

        .elephant-list-switcher-label {
          white-space: nowrap;
        }

        .elephant-list-switcher-icon {
          transition: transform 0.2s;
          opacity: 0.6;
        }

        .elephant-list-switcher-button:hover .elephant-list-switcher-icon {
          opacity: 1;
        }

        .elephant-list-switcher-button[aria-expanded='true'] {
          color: #0066cc;
        }

        .elephant-list-switcher-button[aria-expanded='true'] .elephant-list-switcher-icon {
          transform: rotate(180deg);
          opacity: 1;
        }

        .elephant-list-switcher-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 999;
        }

        .elephant-list-switcher-dropdown {
          position: absolute;
          top: calc(100% + 0.25rem);
          left: 0;
          min-width: 220px;
          background: white;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
          z-index: 1000;
          overflow: hidden;
          padding: 0.5rem 0;
        }

        .elephant-list-switcher-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          padding: 0.75rem 1rem;
          background: transparent;
          border: none;
          cursor: pointer;
          font-size: 0.9rem;
          color: #333;
          text-align: left;
          transition: background 0.15s;
          gap: 0.75rem;
        }

        .elephant-list-switcher-item:hover {
          background: #f8f9fa;
        }

        .elephant-list-switcher-item.active {
          background: #e8f4fd;
          color: #0066cc;
          font-weight: 500;
        }

        .elephant-list-switcher-item-name {
          flex: 1;
        }

        .elephant-list-switcher-item-badge {
          font-size: 0.7rem;
          padding: 0.15rem 0.5rem;
          background: #0066cc;
          color: white;
          border-radius: 3px;
          text-transform: uppercase;
          font-weight: 600;
          letter-spacing: 0.5px;
        }

        .elephant-list-switcher-item.active .elephant-list-switcher-item-badge {
          background: #004d99;
        }

        .elephant-list-switcher-item-check {
          color: #0066cc;
          flex-shrink: 0;
        }

        @media (max-width: 768px) {
          .elephant-list-switcher-button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
          }

          .elephant-list-switcher-dropdown {
            min-width: 200px;
          }

          .elephant-list-switcher-item {
            padding: 0.65rem 0.875rem;
            font-size: 0.85rem;
          }
        }
      `}</style>
    </div>
  );
}
</file>

<file path="app/components/ManualReprocessButton.tsx">
'use client';

import { useTransition } from 'react';

interface ManualReprocessButtonProps {
  onReprocess: () => Promise<void>;
}

export default function ManualReprocessButton({ onReprocess }: ManualReprocessButtonProps) {
  const [isPending, startTransition] = useTransition();

  const handleClick = () => {
    startTransition(async () => {
      await onReprocess();
    });
  };

  return (
    <button
      type="button"
      onClick={handleClick}
      className="btn-warning"
      disabled={isPending}
      style={{ cursor: isPending ? 'wait' : 'pointer' }}
    >
      {isPending ? 'Processing...' : 'MANUAL REPROCESS'}
    </button>
  );
}
</file>

<file path="app/components/QuickCompleteButton.tsx">
'use client';

import { useState } from 'react';
import { completeItem } from '@/lib/actions/items';

interface QuickCompleteButtonProps {
  position: number;
}

export default function QuickCompleteButton({ position }: QuickCompleteButtonProps) {
  const [isLoading, setIsLoading] = useState(false);

  const handleComplete = async () => {
    setIsLoading(true);
    try {
      await completeItem(position);
      window.location.reload();
    } catch (error) {
      setIsLoading(false);
    }
  };

  return (
    <button
      onClick={handleComplete}
      disabled={isLoading}
      className="btn-success btn-small"
      style={{ minWidth: '80px' }}
    >
      {isLoading ? '...' : '‚úì'}
    </button>
  );
}
</file>

<file path="app/dashboard/page.tsx">
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getProfile } from '@/lib/actions/profile';
import { getProjects } from '@/lib/actions/projects';
import { createNewItem } from '@/lib/actions/items';
import { createNewProject } from '@/lib/actions/projects';
import {
  getDashboardStats,
  getNextItems,
  getActiveProjectsOverview,
  getRecentActivity,
} from '@/lib/actions/dashboard';
import AddItemForm from '@/components/AddItemForm';
import QuickCompleteButton from '@/app/components/QuickCompleteButton';
import Link from 'next/link';

async function handleAddItem(formData: FormData) {
  'use server';
  
  const name = formData.get('name') as string;
  const projectSelect = formData.get('project_select') as string;
  const newProjectName = formData.get('new_project_name') as string;
  const newProjectPriority = formData.get('new_project_priority') as string;
  
  if (!name) {
    redirect('/dashboard');
    return;
  }
  
  let projectId: string | null = null;
  
  if (projectSelect === 'new' && newProjectName) {
    const priority = parseInt(newProjectPriority) || 3;
    const result = await createNewProject(newProjectName, priority);
    if (!result.success) {
      redirect('/dashboard');
      return;
    }
    projectId = result.projectId;
  } else if (projectSelect && projectSelect !== 'new') {
    projectId = projectSelect;
  }
  
  const result = await createNewItem(name, projectId);
  if (!result.success) {
    redirect('/dashboard');
    return;
  }
  
  redirect('/dashboard');
}

function formatTimeAgo(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) {
    return diffMins <= 1 ? 'Just now' : `${diffMins} minutes ago`;
  } else if (diffHours < 24) {
    return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
  } else if (diffDays === 1) {
    return 'Yesterday';
  } else if (diffDays < 7) {
    return `${diffDays} days ago`;
  } else {
    return date.toLocaleDateString();
  }
}

function renderPriorityStars(priority: number): string {
  const filled = '‚òÖ'.repeat(priority);
  const empty = '‚òÜ'.repeat(5 - priority);
  return filled + empty;
}

export default async function DashboardPage({
  searchParams,
}: {
  searchParams: Promise<{ error?: string }>;
}) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  const query = await searchParams;
  const { data: profile } = await getProfile();
  const { data: projects } = await getProjects();

  const stats = await getDashboardStats(user.id);
  const nextItems = await getNextItems(user.id, 3);
  const activeProjectsOverview = await getActiveProjectsOverview(user.id);
  const recentActivity = await getRecentActivity(user.id, 5);

  const currentDate = new Date();
  const dateOptions: Intl.DateTimeFormatOptions = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  };
  const timeOptions: Intl.DateTimeFormatOptions = {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
  };
  const formattedDate = currentDate.toLocaleDateString('en-US', dateOptions);
  const formattedTime = currentDate.toLocaleTimeString('en-US', timeOptions);

  return (
    <div className="page-container">
      <div className="dashboard-hero">
        <h1 className="hero-welcome">üëã Welcome back, {profile?.first_name || 'User'}!</h1>
        <p className="hero-date">{formattedDate} ‚Ä¢ {formattedTime}</p>
        <p className="hero-tagline">One bite at a time üêò</p>
      </div>
      
      {query.error && (
        <div style={{ padding: '1rem', marginBottom: '1rem', backgroundColor: '#fee', border: '1px solid #fcc', borderRadius: '4px', color: '#c33' }}>
          {query.error}
        </div>
      )}

      <div className="dashboard-stats-grid">
        <div className="dashboard-stat-card">
          <div className="stat-icon">üìã</div>
          <div className="stat-number">{stats.itemsToday}</div>
          <div className="stat-label">Items Today</div>
          <div className="stat-subtext">Ready to tackle</div>
        </div>

        <div className="dashboard-stat-card">
          <div className="stat-icon">üéØ</div>
          <div className="stat-number">{stats.activeProjects}</div>
          <div className="stat-label">Active Projects</div>
          <div className="stat-subtext">In progress</div>
        </div>

        <div className="dashboard-stat-card">
          <div className="stat-icon">‚úÖ</div>
          <div className="stat-number">{stats.completedThisWeek}</div>
          <div className="stat-label">Completed This Week</div>
          <div className="stat-subtext">Great progress!</div>
        </div>

        <div className="dashboard-stat-card">
          <div className="stat-icon">üî•</div>
          <div className="stat-number">{stats.currentStreak}</div>
          <div className="stat-label">Day Streak</div>
          <div className="stat-subtext">Keep it going!</div>
        </div>
      </div>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Next Up</h2>
          <Link href="/master-list" className="section-link">View Full List ‚Üí</Link>
        </div>
        {nextItems.length > 0 ? (
          <div className="next-up-list">
            {nextItems.map((item) => (
              <div key={item.id} className="next-up-item">
                <div className="next-up-content">
                  <div className="next-up-number">{item.position}</div>
                  <div className="next-up-details">
                    <div className="next-up-name">{item.itemName}</div>
                    <div className="next-up-project">
                      {item.projectName && item.projectId ? (
                        <>
                          Project: <a href={`/projects/${item.projectId}`} style={{ color: 'inherit', textDecoration: 'underline' }}>{item.projectName}</a>
                        </>
                      ) : item.projectName ? (
                        `Project: ${item.projectName}`
                      ) : (
                        'Errand'
                      )}
                    </div>
                  </div>
                </div>
                <QuickCompleteButton position={item.position} />
              </div>
            ))}
          </div>
        ) : (
          <div className="empty-state-small">
            <p>No items in your list yet. Add your first item below!</p>
          </div>
        )}
      </section>

      {activeProjectsOverview.length > 0 && (
        <section className="section">
          <div className="section-header">
            <h2 className="section-title">Your Active Projects</h2>
            <Link href="/projects" className="section-link">Manage Projects ‚Üí</Link>
          </div>
          <div className="dashboard-projects-grid">
            {activeProjectsOverview.map((project) => (
              <div key={project.id} className="dashboard-project-card">
                <h3 className="project-card-name">{project.name}</h3>
                <div className="project-card-priority">{renderPriorityStars(project.priority)}</div>
                <div className="project-card-progress-bar">
                  <div
                    className="project-card-progress-fill"
                    style={{ width: `${project.progress}%` }}
                  ></div>
                </div>
                <div className="project-card-stats">
                  {project.completedItems} of {project.totalItems} items completed
                </div>
                <div className="project-card-stats">{project.activeItems} items active</div>
                <Link href={`/projects/${project.id}`} className="project-card-link">
                  View Project ‚Üí
                </Link>
              </div>
            ))}
          </div>
        </section>
      )}

      {recentActivity.length > 0 && (
        <section className="section">
          <div className="section-header">
            <h2 className="section-title">Recent Activity</h2>
            <Link href="/completed" className="section-link">View All Completed ‚Üí</Link>
          </div>
          <div className="recent-activity-list">
            {recentActivity.map((item) => (
              <div key={item.id} className="recent-activity-item">
                <span className="activity-icon">‚úÖ</span>
                <span className="activity-text">
                  Completed &quot;{item.name}&quot;
                  {item.projectName && ` (${item.projectName})`}
                </span>
                <span className="activity-time">{formatTimeAgo(item.dateCompleted!)}</span>
              </div>
            ))}
          </div>
        </section>
      )}

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Quick Actions</h2>
        </div>
        <div className="dashboard-quick-actions">
          <Link href="/do-now" className="dashboard-action-btn dashboard-action-primary">
            <span className="action-icon">üéØ</span>
            <span className="action-text">Start Working</span>
          </Link>
          <Link href="/master-list" className="dashboard-action-btn dashboard-action-secondary">
            <span className="action-icon">üìä</span>
            <span className="action-text">View Master List</span>
          </Link>
          <Link href="/projects" className="dashboard-action-btn dashboard-action-secondary">
            <span className="action-icon">üìÅ</span>
            <span className="action-text">Manage Projects</span>
          </Link>
        </div>
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Add New Item</h2>
        </div>
        <AddItemForm projects={projects || []} onSubmit={handleAddItem} />
      </section>
    </div>
  );
}
</file>

<file path="app/do-now/page.tsx">
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getFirstMasterListEntry } from '@/lib/actions/masterlist';
import { mapMasterListItem } from '@/lib/utils/masterlist';
import { completeItem, takeABite, createNewItem, completeItemAndNextFromProject } from '@/lib/actions/items';
import { getProjects, createNewProject } from '@/lib/actions/projects';
import AddItemForm from '@/components/AddItemForm';

async function handleComplete() {
  'use server';
  await completeItem(1);
  redirect('/do-now');
}

async function handleCompleteAndNextFromProject() {
  'use server';
  await completeItemAndNextFromProject(1);
  redirect('/do-now');
}

async function handleTakeABite(formData: FormData) {
  'use server';
  const text1 = formData.get('text1') as string;
  const text2 = formData.get('text2') as string;
  
  if (text1 && text2) {
    await takeABite(1, text1, text2);
  }
  
  redirect('/do-now');
}

async function handleAddItem(formData: FormData) {
  'use server';
  
  const name = formData.get('name') as string;
  const projectSelect = formData.get('project_select') as string;
  const newProjectName = formData.get('new_project_name') as string;
  const newProjectPriority = formData.get('new_project_priority') as string;
  
  if (!name) {
    redirect('/do-now');
    return;
  }
  
  let projectId: string | null = null;
  
  if (projectSelect === 'new' && newProjectName) {
    const priority = parseInt(newProjectPriority) || 3;
    const result = await createNewProject(newProjectName, priority);
    projectId = result.projectId;
  } else if (projectSelect && projectSelect !== 'new') {
    projectId = projectSelect;
  }
  
  await createNewItem(name, projectId);
  redirect('/do-now');
}

export default async function DoNowPage({
  searchParams,
}: {
  searchParams: Promise<{ showBite?: string }>;
}) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  const params = await searchParams;
  const { data: masterListEntry } = await getFirstMasterListEntry();
  const { data: projects } = await getProjects();

  if (!masterListEntry) {
    return (
      <div className="page-container">
        <div className="page-header">
          <h1 className="page-title">Do Now</h1>
          <p className="page-subtitle">Focus on your current task</p>
        </div>
        <div className="table-empty">
          <p>No items in queue. Add items from the <a href="/dashboard">Dashboard</a></p>
        </div>
      </div>
    );
  }

  const { itemName, projectName, projectId } = await mapMasterListItem(masterListEntry);

  if (itemName === 'No Active Items' || itemName === 'Error Loading Item') {
    return (
      <div className="page-container">
        <div className="page-header">
          <h1 className="page-title">Do Now</h1>
          <p className="page-subtitle">Focus on your current task</p>
        </div>
        <div className="table-empty">
          <p>No valid items in queue. Please go to <a href="/master-list">Master List</a> and click &quot;MANUAL REPROCESS&quot; to fix the queue.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      <div className="page-header">
        <h1 className="page-title">Do Now</h1>
        <p className="page-subtitle">Focus on your current task</p>
      </div>

      <section className="section">
        <div className="item-display">
          <div className="item-name">{itemName}</div>
          {projectName && projectId && (
            <div className="project-name">
              <a href={`/projects/${projectId}`} style={{ color: 'inherit', textDecoration: 'underline' }}>
                {projectName}
              </a>
            </div>
          )}
          {projectName && !projectId && <div className="project-name">{projectName}</div>}

          <div className="action-buttons">
            <form>
              <button type="submit" formAction={handleComplete} className="btn-success">Completed!</button>
            </form>
            {projectId && (
              <form>
                <button type="submit" formAction={handleCompleteAndNextFromProject} className="btn-primary">Next from Project</button>
              </form>
            )}
            <a href="/do-now?showBite=true">
              <button type="button" className="btn-warning">Take a Bite</button>
            </a>
          </div>
        </div>
      </section>

      {params.showBite === 'true' && (
        <section className="section">
          <div className="section-header">
            <h2 className="section-title">Take a Bite</h2>
          </div>
          <form>
            <div className="form-group">
              <label htmlFor="text1">Current Item (edit if needed)</label>
              <input id="text1" name="text1" type="text" defaultValue={itemName} required placeholder="Edit current item" />
            </div>
            <div className="form-group">
              <label htmlFor="text2">New Item</label>
              <input id="text2" name="text2" type="text" required placeholder="Enter new item" />
            </div>
            <div className="form-actions">
              <button type="submit" formAction={handleTakeABite} className="btn-primary">Submit</button>
              <a href="/do-now">
                <button type="button" className="btn-secondary">Cancel</button>
              </a>
            </div>
          </form>
        </section>
      )}

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Add Item</h2>
        </div>
        <AddItemForm projects={projects || []} onSubmit={handleAddItem} />
      </section>
    </div>
  );
}
</file>

<file path="app/master-list/page.tsx">
import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { redirect } from 'next/navigation';
import { getMasterList } from '@/lib/actions/masterlist';
import { mapMasterListItem } from '@/lib/utils/masterlist';
import { completeItem, editItem, deleteMasterListItem } from '@/lib/actions/items';
import { reprocessList } from '@/lib/actions/reprocess';
import ManualReprocessButton from '@/app/components/ManualReprocessButton';

async function handleComplete(position: number) {
  'use server';
  await completeItem(position);
  redirect('/master-list');
}

async function handleEdit(position: number, formData: FormData) {
  'use server';
  const newName = formData.get('name') as string;
  if (newName) {
    await editItem(position, newName);
  }
  redirect('/master-list');
}

async function handleDelete(position: number) {
  'use server';
  await deleteMasterListItem(position);
  redirect('/master-list');
}

async function handleReprocess() {
  'use server';
  const supabase = await createClient();
  const adminClient = createAdminClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();
  
  if (user) {
    await deactivateOrphanedActiveItems(user.id);
    await restoreOrphanedActiveItems(user.id);
    await cleanupInvalidPlaceholders(user.id);
    await reprocessList(user.id);
  }
  redirect('/master-list');
}

async function deactivateOrphanedActiveItems(userId: string) {
  'use server';
  const adminClient = createAdminClient();

  const { data: projects } = await adminClient
    .from('projects')
    .select('id')
    .eq('user_id', userId)
    .eq('status', 'Active');

  if (!projects || projects.length === 0) return;

  for (const project of projects) {
    const projectId = project.id;

    const { data: allPlaceholders } = await adminClient
      .from('master_list')
      .select('project_placeholder_id')
      .eq('user_id', userId)
      .not('project_placeholder_id', 'is', null);

    let placeholderCount = 0;
    if (allPlaceholders && allPlaceholders.length > 0) {
      for (const p of allPlaceholders) {
        if (p.project_placeholder_id) {
          const parts = p.project_placeholder_id.split('-');
          const extractedProjectId = parts.slice(0, -1).join('-');
          if (extractedProjectId === projectId) {
            placeholderCount++;
          }
        }
      }
    }

    const { data: activeItems } = await adminClient
      .from('project_item_links')
      .select(`
        item_id,
        items!inner(id, status)
      `)
      .eq('project_id', projectId)
      .eq('items.status', 'Active')
      .order('sequence', { ascending: true });

    if (!activeItems || activeItems.length === 0) continue;

    const activeCount = activeItems.length;

    if (activeCount > placeholderCount) {
      const itemsToDeactivate = activeCount - placeholderCount;
      const itemsToDeactivateList = activeItems.slice(-itemsToDeactivate);

      for (const link of itemsToDeactivateList) {
        const itemId = (link.items as any).id;
        await adminClient
          .from('items')
          .update({ status: 'Inactive' })
          .eq('id', itemId);
      }
    }
  }
}

async function restoreOrphanedActiveItems(userId: string) {
  'use server';
  const adminClient = createAdminClient();

  const { data: activeProjectItems } = await adminClient
    .from('project_item_links')
    .select(`
      item_id,
      project_id,
      items!inner(id, status)
    `)
    .eq('items.status', 'Active');

  if (!activeProjectItems || activeProjectItems.length === 0) return;

  for (const link of activeProjectItems) {
    const itemId = link.item_id;
    const projectId = link.project_id;

    const { data: allPlaceholders } = await adminClient
      .from('master_list')
      .select('id, project_placeholder_id')
      .eq('user_id', userId)
      .not('project_placeholder_id', 'is', null);

    let existingEntry = null;
    let nextIndex = 1;

    if (allPlaceholders && allPlaceholders.length > 0) {
      for (const p of allPlaceholders) {
        if (p.project_placeholder_id) {
          const parts = p.project_placeholder_id.split('-');
          const extractedProjectId = parts.slice(0, -1).join('-');
          const index = parseInt(parts[parts.length - 1]);

          if (extractedProjectId === projectId) {
            existingEntry = p;
            if (!isNaN(index) && index >= nextIndex) {
              nextIndex = index + 1;
            }
          }
        }
      }
    }

    if (!existingEntry) {

      const { data: maxPosition } = await adminClient
        .from('master_list')
        .select('position')
        .eq('user_id', userId)
        .order('position', { ascending: false })
        .limit(1)
        .maybeSingle();

      const nextPosition = (maxPosition?.position || 0) + 1;

      await adminClient
        .from('master_list')
        .insert({
          user_id: userId,
          position: nextPosition,
          item_id: null,
          project_placeholder_id: `${projectId}-${nextIndex}`
        });
    }
  }
}

async function cleanupInvalidPlaceholders(userId: string) {
  'use server';
  const supabase = await createClient();
  
  const { data: masterList } = await supabase
    .from('master_list')
    .select('*')
    .eq('user_id', userId)
    .not('project_placeholder_id', 'is', null);
  
  if (!masterList) return;
  
  for (const entry of masterList) {
    if (entry.project_placeholder_id) {
      const parts = entry.project_placeholder_id.split('-');
      const projectId = parts.slice(0, -1).join('-');
      const placeholderIndex = parseInt(parts[parts.length - 1]);
      
      const { data: activeItems } = await supabase
        .from('project_item_links')
        .select(`
          item_id,
          items!inner(id, status)
        `)
        .eq('project_id', projectId)
        .eq('items.status', 'Active')
        .order('sequence', { ascending: true });
      
      if (!activeItems || activeItems.length < placeholderIndex) {
        await supabase
          .from('master_list')
          .delete()
          .eq('id', entry.id);
      }
    }
  }
  
  const { data: entries } = await supabase
    .from('master_list')
    .select('id')
    .eq('user_id', userId)
    .order('position', { ascending: true });
  
  if (entries) {
    for (let i = 0; i < entries.length; i++) {
      await supabase
        .from('master_list')
        .update({ position: i + 1 })
        .eq('id', entries[i].id);
    }
  }
}

async function handleExport() {
  'use server';
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  const { data: masterList } = await supabase
    .from('master_list')
    .select('*')
    .eq('user_id', user.id)
    .order('position', { ascending: true });

  const exportData = JSON.stringify(masterList, null, 2);
  
  redirect('/master-list');
}

export default async function MasterListPage({
  searchParams,
}: {
  searchParams: Promise<{ edit?: string }>;
}) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  const query = await searchParams;
  const { data: masterList } = await getMasterList();

  const mappedItems = await Promise.all(
    (masterList || []).map(async (entry: any) => {
      const mapped = await mapMasterListItem(entry);
      return {
        ...entry,
        ...mapped,
      };
    })
  );

  const validItems = mappedItems;

  return (
    <div className="page-container">
      <div className="page-header">
        <h1 className="page-title">Master List</h1>
        <p className="page-subtitle">View with caution - Testing only</p>
      </div>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Master List Entries</h2>
        </div>
        {!validItems || validItems.length === 0 ? (
          <div className="table-empty">
            <p>Master list is empty.</p>
          </div>
        ) : (
          <div className="table-container">
            <table className="data-table">
              <thead>
                <tr>
                  <th style={{ width: '80px' }}>Position</th>
                  <th>Item Name</th>
                  <th style={{ width: '200px' }}>Project Name</th>
                  <th className="actions-column" style={{ width: '240px' }}>Actions</th>
                </tr>
              </thead>
              <tbody>
              {validItems.map((entry: any) => {
                const isEditing = query.edit === entry.position.toString();

                return (
                  <tr key={entry.id}>
                    <td>{entry.position}</td>
                    <td>
                      {isEditing ? (
                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                          <form style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', margin: 0, padding: 0, boxShadow: 'none', background: 'transparent' }}>
                            <input
                              name="name"
                              type="text"
                              defaultValue={entry.itemName}
                              required
                              style={{ flex: 1, minWidth: '200px' }}
                            />
                            <button type="submit" formAction={handleEdit.bind(null, entry.position)} className="btn-success" style={{ padding: '0.35rem 0.65rem', fontSize: '0.8rem' }}>
                              Save
                            </button>
                          </form>
                          <a href="/master-list">
                            <button type="button" className="btn-secondary" style={{ padding: '0.35rem 0.65rem', fontSize: '0.8rem' }}>Cancel</button>
                          </a>
                        </div>
                      ) : (
                        entry.itemName
                      )}
                    </td>
                    <td>
                      {entry.projectName && entry.projectId ? (
                        <a href={`/projects/${entry.projectId}`} style={{ color: 'inherit', textDecoration: 'underline' }}>
                          {entry.projectName}
                        </a>
                      ) : (
                        entry.projectName || '-'
                      )}
                    </td>
                    <td className="actions-column">
                      {!isEditing && (
                        <>
                          <form>
                            <button type="submit" formAction={handleComplete.bind(null, entry.position)} className="btn-success">
                              Complete
                            </button>
                          </form>
                          <a href={`/master-list?edit=${entry.position}`}>
                            <button type="button" className="btn-warning">Edit</button>
                          </a>
                          <form>
                            <button type="submit" formAction={handleDelete.bind(null, entry.position)} className="btn-danger">
                              Delete
                            </button>
                          </form>
                        </>
                      )}
                    </td>
                  </tr>
              );
            })}
              </tbody>
            </table>
          </div>
        )}
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Actions</h2>
        </div>
        <div style={{ margin: 0, padding: 0 }}>
          <ManualReprocessButton onReprocess={handleReprocess} />
        </div>
      </section>
    </div>
  );
}
</file>

<file path="app/projects/[id]/page.tsx">
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getProjectItems } from '@/lib/actions/project-items';
import { createNewItem } from '@/lib/actions/items';
import ProjectDetailClient from '@/components/ProjectDetailClient';

async function handleAddItem(projectId: string, formData: FormData) {
  'use server';
  
  const entries = Array.from(formData.entries());
  const itemNames = entries
    .filter(([key]) => key.startsWith('name_'))
    .map(([_, value]) => value as string)
    .filter(name => name && name.trim() !== '');

  for (const name of itemNames) {
    await createNewItem(name, projectId);
  }
  
  redirect(`/projects/${projectId}`);
}

export default async function ProjectDetailPage({
  params,
  searchParams,
}: {
  params: Promise<{ id: string }>;
  searchParams: Promise<{ editItem?: string }>;
}) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  const { id: projectId } = await params;
  const query = await searchParams;

  const { data: project } = await supabase
    .from('projects')
    .select('*')
    .eq('id', projectId)
    .eq('user_id', user.id)
    .single();

  if (!project) {
    redirect('/projects');
  }

  const { data: projectItems } = await getProjectItems(projectId);

  return (
    <ProjectDetailClient
      projectId={projectId}
      project={project}
      projectItems={projectItems || []}
      editItemId={query.editItem}
      onAddItem={handleAddItem.bind(null, projectId)}
    />
  );
}
</file>

<file path="app/projects/page.tsx">
import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { redirect } from 'next/navigation';
import { createNewProject } from '@/lib/actions/projects';
import { revalidatePath } from 'next/cache';
import ProjectActions from '@/components/ProjectActions';

async function handleCreateProject(formData: FormData) {
  'use server';
  
  const name = formData.get('name') as string;
  const priority = parseInt(formData.get('priority') as string);
  
  if (name) {
    const result = await createNewProject(name, priority);
    redirect(`/projects/${result.projectId}`);
  }
  
  redirect('/projects');
}

async function completeProject(projectId: string) {
  'use server';
  const supabase = await createClient();
  const adminClient = createAdminClient();
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/projects');
    return;
  }

  const { data: projectItems } = await adminClient
    .from('project_item_links')
    .select('item_id, items!inner(id, status)')
    .eq('project_id', projectId);

  if (projectItems && projectItems.length > 0) {
    for (const link of projectItems) {
      const item = link.items as any;
      if (item.status === 'Active' || item.status === 'Inactive') {
        await adminClient
          .from('items')
          .update({ 
            status: 'Completed',
            date_completed: new Date().toISOString()
          })
          .eq('id', item.id);
      }
    }
  }

  const { data: allPlaceholders } = await adminClient
    .from('master_list')
    .select('id, project_placeholder_id')
    .eq('user_id', user.id)
    .not('project_placeholder_id', 'is', null);

  if (allPlaceholders && allPlaceholders.length > 0) {
    for (const p of allPlaceholders) {
      if (p.project_placeholder_id) {
        const parts = p.project_placeholder_id.split('-');
        const extractedProjectId = parts.slice(0, -1).join('-');
        if (extractedProjectId === projectId) {
          await adminClient
            .from('master_list')
            .delete()
            .eq('id', p.id);
        }
      }
    }
  }

  await adminClient
    .from('projects')
    .update({ status: 'Inactive' })
    .eq('id', projectId);

  revalidatePath('/projects');
  revalidatePath('/master-list');
  revalidatePath('/do-now');
  revalidatePath('/dashboard');
  redirect('/projects');
}

async function deleteProject(projectId: string) {
  'use server';
  const supabase = await createClient();
  const adminClient = createAdminClient();
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/projects');
    return;
  }

  const { data: projectItems } = await adminClient
    .from('project_item_links')
    .select('item_id, items!inner(id, status)')
    .eq('project_id', projectId);

  if (projectItems && projectItems.length > 0) {
    for (const link of projectItems) {
      const item = link.items as any;
      if (item.status === 'Active' || item.status === 'Inactive') {
        await adminClient
          .from('project_item_links')
          .delete()
          .eq('item_id', item.id);

        await adminClient
          .from('items')
          .delete()
          .eq('id', item.id);
      }
    }
  }

  const { data: allPlaceholders } = await adminClient
    .from('master_list')
    .select('id, project_placeholder_id')
    .eq('user_id', user.id)
    .not('project_placeholder_id', 'is', null);

  if (allPlaceholders && allPlaceholders.length > 0) {
    for (const p of allPlaceholders) {
      if (p.project_placeholder_id) {
        const parts = p.project_placeholder_id.split('-');
        const extractedProjectId = parts.slice(0, -1).join('-');
        if (extractedProjectId === projectId) {
          await adminClient
            .from('master_list')
            .delete()
            .eq('id', p.id);
        }
      }
    }
  }

  await adminClient
    .from('projects')
    .delete()
    .eq('id', projectId);

  revalidatePath('/projects');
  revalidatePath('/master-list');
  revalidatePath('/do-now');
  revalidatePath('/dashboard');
  redirect('/projects');
}

export default async function ProjectsPage() {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  const { data: activeProjects } = await supabase
    .from('projects')
    .select('*, project_item_links(count)')
    .eq('user_id', user.id)
    .eq('status', 'Active')
    .order('priority', { ascending: false });

  const { data: inactiveProjects } = await supabase
    .from('projects')
    .select('*, project_item_links(count)')
    .eq('user_id', user.id)
    .eq('status', 'Inactive')
    .order('priority', { ascending: false });

  return (
    <div className="page-container">
      <div className="page-header">
        <h1 className="page-title">Projects</h1>
        <p className="page-subtitle">Manage your projects and tasks</p>
      </div>
      
      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Active Projects</h2>
        </div>
        {!activeProjects || activeProjects.length === 0 ? (
          <div className="table-empty">
            <p>No active projects.</p>
          </div>
        ) : (
          <div className="table-container">
            <table className="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Priority</th>
                  <th>Item Count</th>
                  <th className="actions-column">Actions</th>
                </tr>
              </thead>
              <tbody>
                {activeProjects.map((project: any) => (
                  <tr key={project.id}>
                    <td>
                      <a href={`/projects/${project.id}`}>{project.name}</a>
                    </td>
                    <td>{project.priority}</td>
                    <td>{project.project_item_links?.[0]?.count || 0}</td>
                    <td className="actions-column">
                      <ProjectActions
                        projectId={project.id}
                        projectName={project.name}
                        onComplete={completeProject}
                        onDelete={deleteProject}
                      />
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Inactive Projects</h2>
        </div>
        {!inactiveProjects || inactiveProjects.length === 0 ? (
          <div className="table-empty">
            <p>No inactive projects.</p>
          </div>
        ) : (
          <div className="table-container">
            <table className="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Priority</th>
                  <th>Item Count</th>
                </tr>
              </thead>
              <tbody>
                {inactiveProjects.map((project: any) => (
                  <tr key={project.id}>
                    <td>
                      <a href={`/projects/${project.id}`}>{project.name}</a>
                    </td>
                    <td>{project.priority}</td>
                    <td>{project.project_item_links?.[0]?.count || 0}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Create New Project</h2>
        </div>
        <form>
          <div className="form-group">
            <label htmlFor="name">Project Name</label>
            <input id="name" name="name" type="text" required placeholder="Enter project name" />
          </div>
          <div className="form-group">
            <label htmlFor="priority">Priority</label>
            <select id="priority" name="priority" defaultValue="3">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div className="form-actions">
            <button type="submit" formAction={handleCreateProject} className="btn-primary">Create Project</button>
          </div>
        </form>
      </section>
    </div>
  );
}
</file>

<file path="app/settings/lists/page.tsx">
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { getLists, createList, updateList, deleteList, ensureUserHasDefaultList } from '@/lib/actions/lists';
import DeleteListButton from '@/app/components/DeleteListButton';

async function handleCreateList(formData: FormData) {
  'use server';
  const name = formData.get('name') as string;
  await createList(name);
  redirect('/settings/lists');
}

async function handleUpdateList(formData: FormData) {
  'use server';
  const listId = formData.get('listId') as string;
  const name = formData.get('name') as string;
  await updateList(listId, name);
  redirect('/settings/lists');
}

async function handleDeleteList(formData: FormData) {
  'use server';
  const listId = formData.get('listId') as string;
  await deleteList(listId);
  redirect('/settings/lists');
}

export default async function ListsManagementPage({
  searchParams,
}: {
  searchParams: Promise<{ edit?: string }>;
}) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  await ensureUserHasDefaultList();

  const params = await searchParams;
  const { data: lists } = await getLists();
  const editingListId = params.edit;
  const editingList = lists?.find(l => l.id === editingListId);

  return (
    <div className="page-container">
      <div className="page-header">
        <h1 className="page-title">Manage Lists</h1>
        <p className="page-subtitle">Create and manage your task lists</p>
      </div>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Create New List</h2>
        </div>
        <form>
          <div className="form-group">
            <label htmlFor="name">List Name</label>
            <input
              id="name"
              name="name"
              type="text"
              required
              placeholder="Enter list name"
            />
          </div>
          <div className="form-actions">
            <button type="submit" formAction={handleCreateList} className="btn-primary">
              Create List
            </button>
          </div>
        </form>
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Your Lists</h2>
        </div>
        {lists && lists.length > 0 ? (
          <div className="table-container">
            <table className="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {lists.map((list) => (
                  <tr key={list.id}>
                    <td>
                      {editingListId === list.id ? (
                        <form style={{ display: 'inline' }}>
                          <input
                            type="hidden"
                            name="listId"
                            value={list.id}
                          />
                          <input
                            name="name"
                            type="text"
                            defaultValue={list.name}
                            required
                            style={{ width: '200px' }}
                          />
                          <button
                            type="submit"
                            formAction={handleUpdateList}
                            className="btn-sm btn-success"
                            style={{ marginLeft: '0.5rem' }}
                          >
                            Save
                          </button>
                          <a href="/settings/lists">
                            <button
                              type="button"
                              className="btn-sm btn-secondary"
                              style={{ marginLeft: '0.5rem' }}
                            >
                              Cancel
                            </button>
                          </a>
                        </form>
                      ) : (
                        <strong>{list.name}</strong>
                      )}
                    </td>
                    <td>
                      {list.is_default && (
                        <span className="badge badge-primary">Default</span>
                      )}
                    </td>
                    <td>{new Date(list.created_at).toLocaleDateString()}</td>
                    <td>
                      {editingListId !== list.id && (
                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                          <a href={`/settings/lists?edit=${list.id}`} style={{ textDecoration: 'none' }}>
                            <button type="button" className="btn-sm btn-secondary">
                              Rename
                            </button>
                          </a>
                          {!list.is_default && (
                            <DeleteListButton listId={list.id} onDelete={handleDeleteList} />
                          )}
                        </div>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div className="table-empty">
            <p>No lists found. Create your first list above.</p>
          </div>
        )}
      </section>

      <div style={{ marginTop: '2rem' }}>
        <a href="/settings">
          <button type="button" className="btn-secondary">
            Back to Settings
          </button>
        </a>
      </div>
    </div>
  );
}
</file>

<file path="app/settings/test/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { createNewProject } from '@/lib/actions/projects';
import { createNewItem, completeItem } from '@/lib/actions/items';
import { getMasterList } from '@/lib/actions/masterlist';

interface TestResult {
  name: string;
  status: 'pending' | 'running' | 'success' | 'failed';
  message: string;
  duration?: number;
}

export default function TestPage() {
  const router = useRouter();
  const [isRunning, setIsRunning] = useState(false);
  const [progress, setProgress] = useState(0);
  const [total, setTotal] = useState(0);
  const [currentTest, setCurrentTest] = useState('');
  const [results, setResults] = useState<TestResult[]>([]);
  const [logs, setLogs] = useState<string[]>([]);

  const addLog = (message: string) => {
    setLogs(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${message}`]);
  };

  const updateResult = (name: string, status: TestResult['status'], message: string, duration?: number) => {
    setResults(prev => {
      const existing = prev.find(r => r.name === name);
      if (existing) {
        return prev.map(r => r.name === name ? { ...r, status, message, duration } : r);
      }
      return [...prev, { name, status, message, duration }];
    });
  };

  const handleCreate1000Items = async () => {
    if (isRunning) return;
    
    setIsRunning(true);
    setProgress(0);
    setTotal(1000);
    setCurrentTest('Creating 1000 Test Items');
    setResults([]);
    setLogs([]);
    
    const startTime = Date.now();
    
    try {
      addLog('Starting test: Create 1000 items');
      
      // Create test project
      addLog('Creating test project...');
      const projectResult = await createNewProject('üß™ Test Project 1000', 3);
      
      if (!projectResult.success || !projectResult.projectId) {
        throw new Error('Failed to create test project');
      }
      
      addLog(`‚úì Test project created: ${projectResult.projectId}`);
      
      // Create 1000 items
      addLog('Creating 1000 items...');
      let successCount = 0;
      let failCount = 0;
      
      for (let i = 1; i <= 1000; i++) {
        try {
          await createNewItem(`Test Item #${i}`, projectResult.projectId);
          successCount++;
          setProgress(i);
          
          if (i % 100 === 0) {
            addLog(`Progress: ${i}/1000 items created`);
          }
        } catch (error) {
          failCount++;
          addLog(`‚úó Failed to create item ${i}: ${error}`);
        }
      }
      
      const duration = ((Date.now() - startTime) / 1000).toFixed(2);
      const rate = (successCount / parseFloat(duration)).toFixed(2);
      
      addLog(`‚úì Test completed in ${duration}s`);
      addLog(`‚úì Success: ${successCount}, Failed: ${failCount}`);
      addLog(`‚úì Average rate: ${rate} items/second`);
      
      updateResult(
        'Create 1000 Items',
        failCount === 0 ? 'success' : 'failed',
        `Created ${successCount}/1000 items in ${duration}s (${rate} items/sec)`,
        parseFloat(duration)
      );
      
    } catch (error) {
      addLog(`‚úó Test failed: ${error}`);
      updateResult('Create 1000 Items', 'failed', `Error: ${error}`);
    } finally {
      setIsRunning(false);
      setCurrentTest('');
    }
  };

  const handleCompleteAllItems = async () => {
    if (isRunning) return;
    
    setIsRunning(true);
    setProgress(0);
    setCurrentTest('Completing All Items');
    setLogs([]);
    
    const startTime = Date.now();
    
    try {
      addLog('Starting test: Complete all items');
      
      // Get master list
      addLog('Fetching master list...');
      const { data: masterList } = await getMasterList();
      
      if (!masterList || masterList.length === 0) {
        throw new Error('Master list is empty');
      }
      
      setTotal(masterList.length);
      addLog(`Found ${masterList.length} items to complete`);
      
      let successCount = 0;
      let failCount = 0;
      
      for (let i = 0; i < masterList.length; i++) {
        try {
          await completeItem(1); // Always complete position 1
          successCount++;
          setProgress(i + 1);
          
          if ((i + 1) % 50 === 0) {
            addLog(`Progress: ${i + 1}/${masterList.length} items completed`);
          }
        } catch (error) {
          failCount++;
          addLog(`‚úó Failed to complete item at position ${i + 1}: ${error}`);
        }
      }
      
      const duration = ((Date.now() - startTime) / 1000).toFixed(2);
      const rate = (successCount / parseFloat(duration)).toFixed(2);
      
      addLog(`‚úì Test completed in ${duration}s`);
      addLog(`‚úì Success: ${successCount}, Failed: ${failCount}`);
      addLog(`‚úì Average rate: ${rate} items/second`);
      
      updateResult(
        'Complete All Items',
        failCount === 0 ? 'success' : 'failed',
        `Completed ${successCount}/${masterList.length} items in ${duration}s (${rate} items/sec)`,
        parseFloat(duration)
      );
      
    } catch (error) {
      addLog(`‚úó Test failed: ${error}`);
      updateResult('Complete All Items', 'failed', `Error: ${error}`);
    } finally {
      setIsRunning(false);
      setCurrentTest('');
    }
  };

  const handleTestAllFeatures = async () => {
    if (isRunning) return;
    
    setIsRunning(true);
    setProgress(0);
    setTotal(6);
    setCurrentTest('Testing All Features');
    setResults([]);
    setLogs([]);
    
    const tests = [
      {
        name: 'Create Projects',
        fn: async () => {
          addLog('Test 1: Creating projects with different priorities...');
          for (let priority = 1; priority <= 5; priority++) {
            const result = await createNewProject(`üß™ Test Project P${priority}`, priority as 1 | 2 | 3 | 4 | 5);
            if (!result.success) throw new Error(`Failed to create project with priority ${priority}`);
          }
          addLog('‚úì Created 5 projects with priorities 1-5');
        }
      },
      {
        name: 'Add Errands',
        fn: async () => {
          addLog('Test 2: Adding errand items...');
          for (let i = 1; i <= 10; i++) {
            const result = await createNewItem(`üß™ Test Errand ${i}`, null);
            if (!result.success) throw new Error(`Failed to create errand ${i}`);
          }
          addLog('‚úì Created 10 errand items');
        }
      },
      {
        name: 'Add Project Items',
        fn: async () => {
          addLog('Test 3: Adding project items...');
          const projectResult = await createNewProject('üß™ Test Project Items', 3);
          if (!projectResult.success || !projectResult.projectId) throw new Error('Failed to create project');
          
          for (let i = 1; i <= 5; i++) {
            const result = await createNewItem(`üß™ Project Item ${i}`, projectResult.projectId);
            if (!result.success) throw new Error(`Failed to create project item ${i}`);
          }
          addLog('‚úì Created project with 5 items');
        }
      },
      {
        name: 'Complete Items',
        fn: async () => {
          addLog('Test 4: Completing items...');
          for (let i = 1; i <= 5; i++) {
            await completeItem(1);
          }
          addLog('‚úì Completed 5 items successfully');
        }
      },
      {
        name: 'Master List Check',
        fn: async () => {
          addLog('Test 5: Checking master list...');
          const { data: masterList } = await getMasterList();
          if (!masterList) throw new Error('Failed to fetch master list');
          addLog(`‚úì Master list has ${masterList.length} items`);
        }
      },
      {
        name: 'Performance Check',
        fn: async () => {
          addLog('Test 6: Performance check...');
          const start = Date.now();
          for (let i = 1; i <= 10; i++) {
            await createNewItem(`üß™ Perf Test ${i}`, null);
          }
          const duration = Date.now() - start;
          const rate = (10000 / duration).toFixed(2);
          addLog(`‚úì Created 10 items in ${duration}ms (${rate} items/sec)`);
        }
      }
    ];

    for (let i = 0; i < tests.length; i++) {
      const test = tests[i];
      const startTime = Date.now();
      
      try {
        await test.fn();
        const duration = ((Date.now() - startTime) / 1000).toFixed(2);
        updateResult(test.name, 'success', `Passed in ${duration}s`, parseFloat(duration));
        setProgress(i + 1);
      } catch (error) {
        addLog(`‚úó ${test.name} failed: ${error}`);
        updateResult(test.name, 'failed', `Error: ${error}`);
        setProgress(i + 1);
      }
    }
    
    setIsRunning(false);
    setCurrentTest('');
    addLog('‚úì All feature tests completed');
  };

  const handleClearLogs = () => {
    setLogs([]);
    setResults([]);
    setProgress(0);
    setTotal(0);
  };

  return (
    <div className="page-container">
      <div className="page-header">
        <h1 className="page-title">üß™ Test & Validation Tools</h1>
        <p className="page-subtitle">
          ‚ö†Ô∏è For Testing Only - This page can be removed after testing
        </p>
      </div>

      {/* Performance Tests */}
      <section className="section">
        <div className="section-header">
          <h2 className="section-title">üìä Performance Tests</h2>
        </div>
        
        <div style={{ marginBottom: '1.5rem' }}>
          <button
            onClick={handleCreate1000Items}
            disabled={isRunning}
            className="btn-primary"
            style={{ marginRight: '0.5rem' }}
          >
            {isRunning && currentTest.includes('1000') ? 'Creating...' : 'Create 1000 Test Items'}
          </button>
          
          <button
            onClick={handleCompleteAllItems}
            disabled={isRunning}
            className="btn-success"
          >
            {isRunning && currentTest.includes('Completing') ? 'Completing...' : 'Complete All Items'}
          </button>
        </div>

        {isRunning && total > 0 && (
          <div style={{ marginTop: '1rem' }}>
            <div style={{ marginBottom: '0.5rem', fontWeight: 500 }}>
              {currentTest}: {progress}/{total}
            </div>
            <div style={{ 
              width: '100%', 
              height: '30px', 
              backgroundColor: '#e0e0e0', 
              borderRadius: '4px',
              overflow: 'hidden'
            }}>
              <div style={{
                width: `${(progress / total) * 100}%`,
                height: '100%',
                backgroundColor: '#4caf50',
                transition: 'width 0.3s ease',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                color: 'white',
                fontWeight: 'bold'
              }}>
                {((progress / total) * 100).toFixed(1)}%
              </div>
            </div>
          </div>
        )}
      </section>

      {/* Feature Tests */}
      <section className="section">
        <div className="section-header">
          <h2 className="section-title">üß™ Feature Tests</h2>
        </div>
        
        <button
          onClick={handleTestAllFeatures}
          disabled={isRunning}
          className="btn-primary"
        >
          {isRunning && currentTest.includes('Features') ? 'Testing...' : 'Test All Features'}
        </button>

        {results.length > 0 && (
          <div style={{ marginTop: '1.5rem' }}>
            <h3 style={{ marginBottom: '1rem', fontSize: '1.1rem' }}>Test Results:</h3>
            <div className="table-container">
              <table className="data-table">
                <thead>
                  <tr>
                    <th>Test</th>
                    <th>Status</th>
                    <th>Details</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody>
                  {results.map((result, idx) => (
                    <tr key={idx}>
                      <td><strong>{result.name}</strong></td>
                      <td>
                        {result.status === 'success' && <span style={{ color: '#28a745' }}>‚úì PASS</span>}
                        {result.status === 'failed' && <span style={{ color: '#dc3545' }}>‚úó FAIL</span>}
                        {result.status === 'running' && <span style={{ color: '#ffc107' }}>‚è≥ Running</span>}
                        {result.status === 'pending' && <span style={{ color: '#6c757d' }}>‚è∏ Pending</span>}
                      </td>
                      <td>{result.message}</td>
                      <td>{result.duration ? `${result.duration}s` : '-'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </section>

      {/* Logs */}
      {logs.length > 0 && (
        <section className="section">
          <div className="section-header">
            <h2 className="section-title">üìù Test Logs</h2>
            <button onClick={handleClearLogs} className="btn-sm btn-secondary">
              Clear Logs
            </button>
          </div>
          
          <div style={{
            backgroundColor: '#1e1e1e',
            color: '#d4d4d4',
            padding: '1rem',
            borderRadius: '4px',
            fontFamily: 'monospace',
            fontSize: '0.85rem',
            maxHeight: '400px',
            overflowY: 'auto'
          }}>
            {logs.map((log, idx) => (
              <div key={idx} style={{ marginBottom: '0.25rem' }}>
                {log}
              </div>
            ))}
          </div>
        </section>
      )}

      {/* Navigation */}
      <div style={{ marginTop: '2rem' }}>
        <button
          onClick={() => router.push('/settings')}
          className="btn-secondary"
          disabled={isRunning}
        >
          ‚Üê Back to Settings
        </button>
      </div>

      {/* Instructions */}
      <section className="section" style={{ marginTop: '2rem', backgroundColor: '#fff3cd', border: '1px solid #ffc107' }}>
        <h3 style={{ marginBottom: '1rem', color: '#856404' }}>üìñ Instructions</h3>
        <ul style={{ marginLeft: '1.5rem', color: '#856404' }}>
          <li><strong>Create 1000 Items:</strong> Creates a test project with 1000 items to test performance</li>
          <li><strong>Complete All Items:</strong> Completes all items in the master list one by one</li>
          <li><strong>Test All Features:</strong> Runs comprehensive tests on all app features</li>
        </ul>
      </section>
    </div>
  );
}
</file>

<file path="app/settings/page.tsx">
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { signOut } from '@/lib/actions/auth';
import { getProfile, updateProfile } from '@/lib/actions/profile';
import { toggleMasterList, importDatabase, resetApp } from '@/lib/actions/settings';
import ImportDatabaseForm from '@/components/ImportDatabaseForm';
import ResetAppForm from '@/components/ResetAppForm';
import ExportDatabaseForm from '@/components/ExportDatabaseForm';

async function handleToggleMasterList(userId: string) {
  'use server';
  await toggleMasterList(userId);
  redirect('/settings');
}

async function handleImport(userId: string, formData: FormData) {
  'use server';
  const file = formData.get('file') as File;
  if (!file) {
    redirect('/settings?error=' + encodeURIComponent('No file selected'));
    return;
  }
  
  const text = await file.text();
  const result = await importDatabase(userId, text);
  
  if (!result.success) {
    redirect('/settings?error=' + encodeURIComponent(result.error || 'Import failed'));
    return;
  }
  
  redirect('/settings?success=' + encodeURIComponent('Database imported successfully'));
}

async function handleReset(userId: string) {
  'use server';
  await resetApp(userId);
  redirect('/settings');
}

export default async function SettingsPage({
  searchParams,
}: {
  searchParams: Promise<{ action?: string; error?: string; success?: string }>;
}) {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  const query = await searchParams;
  const { data: profile } = await getProfile();

  return (
    <div className="page-container">
      <div className="page-header">
        <h1 className="page-title">Settings</h1>
        <p className="page-subtitle">Manage your account and preferences</p>
      </div>

      {query.error && (
        <div style={{ padding: '1rem', marginBottom: '1rem', backgroundColor: '#fee', border: '1px solid #fcc', borderRadius: '4px', color: '#c33' }}>
          {query.error}
        </div>
      )}

      {query.success && (
        <div style={{ padding: '1rem', marginBottom: '1rem', backgroundColor: '#efe', border: '1px solid #cfc', borderRadius: '4px', color: '#3c3' }}>
          {query.success}
        </div>
      )}

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Account Information</h2>
        </div>
        <p>Email: {user?.email}</p>
        <p>User ID: {user?.id}</p>
        <p>Created: {user?.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</p>
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Profile Settings</h2>
        </div>
        <form>
          <div className="form-group">
            <label htmlFor="username">Username</label>
            <input id="username" name="username" type="text" defaultValue={profile?.username || ''} placeholder="Enter username" />
          </div>
          <div className="form-group">
            <label htmlFor="first_name">First Name</label>
            <input id="first_name" name="first_name" type="text" defaultValue={profile?.first_name || ''} placeholder="Enter first name" />
          </div>
          <div className="form-group">
            <label htmlFor="last_name">Last Name</label>
            <input id="last_name" name="last_name" type="text" defaultValue={profile?.last_name || ''} placeholder="Enter last name" />
          </div>
          <div className="form-group">
            <label htmlFor="birthdate">Birthdate</label>
            <input id="birthdate" name="birthdate" type="date" defaultValue={profile?.birthdate || ''} />
          </div>
          <div className="form-group">
            <label htmlFor="gender">Gender</label>
            <select id="gender" name="gender" defaultValue={profile?.gender || ''}>
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div className="form-group">
            <label htmlFor="show_master_list">
              <input 
                id="show_master_list" 
                name="show_master_list" 
                type="checkbox" 
                value="true"
                defaultChecked={profile?.show_master_list || false}
              />
              Show Master List
            </label>
          </div>
          <div className="form-actions">
            <button type="submit" formAction={updateProfile} className="btn-primary">Update Profile</button>
          </div>
        </form>
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Lists Management</h2>
        </div>
        <p style={{ marginBottom: '1rem', color: '#666' }}>
          Create and manage multiple task lists to organize your work.
        </p>
        <div className="form-actions">
          <a href="/settings/lists">
            <button type="button" className="btn-primary">Manage Lists</button>
          </a>
        </div>
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">App Settings</h2>
        </div>
        <form>
          <div className="form-actions">
            <button type="submit" formAction={handleToggleMasterList.bind(null, user.id)} className="btn-secondary">
              {profile?.show_master_list ? 'Hide' : 'Show'} Master List
            </button>
          </div>
        </form>
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Data Management</h2>
        </div>
        
        <div style={{ marginBottom: '1rem' }}>
          <ExportDatabaseForm userId={user.id} />
        </div>

        <div style={{ marginBottom: '1rem' }}>
          <ImportDatabaseForm onSubmit={handleImport.bind(null, user.id)} />
        </div>

        <div style={{ marginBottom: '1rem' }}>
          <ResetAppForm onSubmit={handleReset.bind(null, user.id)} />
        </div>
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Actions</h2>
        </div>
        <form>
          <div className="form-actions">
            <button type="submit" formAction={signOut} className="btn-secondary">Sign Out</button>
          </div>
        </form>
      </section>
    </div>
  );
}
</file>

<file path="app/globals.css">
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  line-height: 1.5;
  font-size: 14px;
  color: #333;
  background-color: #f5f5f5;
  padding: 0;
  margin: 0;
}

.page-content {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.page-with-header {
  padding-top: 70px;
}

.page-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  min-height: calc(100vh - 70px);
}

.page-header {
  margin-bottom: 24px;
  border-bottom: 2px solid #e9ecef;
  padding-bottom: 12px;
}

.page-title {
  font-size: 28px;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.page-subtitle {
  font-size: 14px;
  color: #666;
  margin-top: 4px;
}

.section {
  margin-bottom: 32px;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.section-title {
  font-size: 20px;
  font-weight: 600;
  color: #333;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title .title-icon {
  font-size: 18px;
}

.section-actions {
  display: flex;
  gap: 8px;
}

h1 {
  font-size: 2rem;
  margin-bottom: 1rem;
  color: #222;
}

h2 {
  font-size: 1.5rem;
  margin: 1.5rem 0 1rem;
  color: #444;
}

a {
  color: #0066cc;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

nav {
  margin: 1.5rem 0;
}

nav a {
  display: inline-block;
  margin-right: 1.5rem;
  margin-bottom: 0.5rem;
  padding: 0.5rem 1rem;
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
  transition: all 0.2s;
}

nav a:hover {
  background-color: #f0f0f0;
  text-decoration: none;
  border-color: #999;
}

form {
  background-color: #fff;
  padding: 1.5rem;
  margin: 1rem 0;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-container {
  max-width: 600px;
  margin: 1rem auto;
}

.form-group {
  margin-bottom: 1rem;
}

.form-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
}

.form-actions button {
  flex: 0 0 auto;
}

.form-inline {
  display: flex;
  gap: 1rem;
  align-items: flex-end;
  flex-wrap: wrap;
}

.form-inline .form-group {
  flex: 1;
  min-width: 150px;
  margin-bottom: 0;
}

label {
  display: block;
  margin-bottom: 0.25rem;
  font-weight: 500;
  color: #555;
  font-size: 0.9rem;
}

input[type="text"],
input[type="email"],
input[type="password"],
input[type="date"],
input[type="datetime-local"],
input[type="number"],
input[type="file"],
select,
textarea {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.875rem;
  font-family: inherit;
  transition: border-color 0.2s, box-shadow 0.2s;
  background-color: #fff;
}

input:focus,
select:focus,
textarea:focus {
  outline: none;
  border-color: #0066cc;
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
}

input::placeholder,
textarea::placeholder {
  color: #999;
}

input:invalid:not(:placeholder-shown),
select:invalid:not(:placeholder-shown),
textarea:invalid:not(:placeholder-shown) {
  border-color: #dc3545;
}

textarea {
  min-height: 80px;
  resize: vertical;
}

input[type="checkbox"] {
  width: auto;
  margin-right: 0.5rem;
}

button {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: 500;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

button:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

button:focus {
  outline: 2px solid #0066cc;
  outline-offset: 2px;
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-primary {
  background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #0052a3 0%, #004080 100%);
  box-shadow: 0 4px 16px rgba(0, 102, 204, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, #28a745 0%, #218838 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.btn-success:hover {
  background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
  box-shadow: 0 4px 16px rgba(40, 167, 69, 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.btn-danger:hover {
  background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
  box-shadow: 0 4px 16px rgba(220, 53, 69, 0.4);
}

.btn-warning {
  background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
  color: #212529;
  box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
}

.btn-warning:hover {
  background: linear-gradient(135deg, #e0a800 0%, #d39e00 100%);
  box-shadow: 0 4px 16px rgba(255, 193, 7, 0.4);
}

.btn-secondary {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
}

.btn-secondary:hover {
  background: linear-gradient(135deg, #5a6268 0%, #545b62 100%);
  box-shadow: 0 4px 16px rgba(108, 117, 125, 0.4);
}

.btn-small {
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
}

.btn-back {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
  color: #fff;
  border: none;
  box-shadow: 0 2px 6px rgba(0, 102, 204, 0.25);
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-back:hover {
  background: linear-gradient(135deg, #0052a3 0%, #004080 100%);
  color: #fff;
  box-shadow: 0 4px 12px rgba(0, 102, 204, 0.35);
}

.item-display {
  background-color: #fff;
  padding: 2rem;
  margin: 1.5rem 0;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.item-name {
  font-size: 2rem;
  font-weight: 600;
  color: #222;
  margin-bottom: 0.5rem;
}

.project-name {
  font-size: 1rem;
  color: #666;
  margin-bottom: 1.5rem;
}

.action-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  margin: 1.5rem 0;
}

.action-buttons form,
.action-buttons a {
  margin: 0;
}

.action-buttons form {
  padding: 0;
  box-shadow: none;
  background: transparent;
}

.action-buttons button {
  margin: 0;
  padding: 0.5rem 1.25rem;
  font-size: 0.9rem;
}

.empty-state {
  background-color: #fff;
  padding: 3rem;
  text-align: center;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.back-link {
  display: inline-block;
  margin-top: 2rem;
  padding: 0.5rem 1rem;
  background-color: #f0f0f0;
  border-radius: 4px;
}

.table-container {
  overflow-x: auto;
  margin: 1.25rem 0;
}

table,
.data-table {
  width: 100%;
  border-collapse: collapse;
  background-color: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

thead {
  background-color: #e9ecef;
}

th {
  padding: 0.75rem;
  text-align: left;
  font-weight: 600;
  color: #333;
  border-bottom: 2px solid #dee2e6;
  font-size: 0.9rem;
}

td {
  padding: 0.625rem 0.75rem;
  border-bottom: 1px solid #e9ecef;
  vertical-align: middle;
  font-size: 0.875rem;
}

tbody tr {
  transition: all 0.2s ease;
}

tbody tr:hover {
  background-color: #f8f9fa;
}

tbody tr:last-child td {
  border-bottom: none;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

tbody tr {
  animation: fadeIn 0.3s ease;
}

.actions-column {
  text-align: right;
  white-space: nowrap;
}

.actions-column button {
  margin-left: 0.25rem;
  padding: 0.35rem 0.65rem;
  font-size: 0.8rem;
}

.actions-column form {
  display: inline-block;
  margin: 0;
  padding: 0;
  box-shadow: none;
}

.table-empty {
  text-align: center;
  padding: 2.5rem;
  color: #999;
  font-style: italic;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

section {
  margin: 2rem 0;
}

.app-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background-color: #fff;
  border-bottom: 2px solid #e9ecef;
  z-index: 1000;
}

.header-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0.75rem 1.25rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 2rem;
  flex: 1;
}

.header-nav {
  display: flex;
  gap: 1.5rem;
  align-items: center;
  margin: 0;
}

.header-list-switcher {
  display: flex;
  align-items: center;
}

.header-nav a {
  color: #555;
  font-weight: 500;
  padding: 0.5rem 0;
  border-top: none;
  border-left: none;
  border-right: none;
  border-bottom: 2px solid transparent;
  margin: 0;
  background: none;
  border-radius: 0;
  box-shadow: none;
}

.header-nav a:hover {
  color: #0066cc;
  text-decoration: none;
  background: none;
  border-bottom-color: #0066cc;
}

.header-nav a.active {
  color: #0066cc;
  border-bottom-color: #0066cc;
}

.header-user {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.user-welcome {
  color: #555;
  font-weight: 500;
}

.logout-btn {
  padding: 0.5rem 1rem;
  background-color: #6c757d;
  font-size: 0.9rem;
}

.logout-btn:hover {
  background-color: #5a6268;
}

.filters-container {
  display: flex;
  gap: 1rem;
  align-items: flex-end;
  background-color: #fff;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 2rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.filter-group label {
  margin-bottom: 0;
  font-size: 0.9rem;
}

.filter-group select {
  min-width: 150px;
}

.project-items-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.project-group {
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
}

.project-header {
  padding: 1rem;
  background-color: #f8f9fa;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  transition: background-color 0.2s;
}

.project-header:hover {
  background-color: #e9ecef;
}

.expand-icon {
  font-size: 0.8rem;
  color: #666;
}

.project-name {
  font-weight: 600;
  color: #333;
}

.item-count {
  color: #666;
  font-size: 0.9rem;
}

.project-items {
  padding: 1rem;
}

.project-items table {
  margin: 0;
  box-shadow: none;
}

@media (max-width: 768px) {
  .page-with-header {
    padding-top: 120px;
  }

  .page-content,
  .page-container {
    padding: 15px;
  }

  .page-title {
    font-size: 24px;
  }

  .section {
    padding: 15px;
    margin-bottom: 24px;
  }

  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .section-title {
    font-size: 18px;
  }

  .section-actions {
    width: 100%;
  }

  .section-actions button {
    flex: 1;
  }

  .header-container {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
  }

  .header-nav {
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header-nav a {
    font-size: 0.9rem;
  }

  .header-user {
    width: 100%;
    justify-content: space-between;
  }

  .user-welcome {
    font-size: 0.9rem;
  }

  h1 {
    font-size: 1.75rem;
  }

  h2 {
    font-size: 1.25rem;
  }

  .item-name {
    font-size: 1.5rem;
  }

  nav a {
    display: block;
    margin-right: 0;
    margin-bottom: 0.75rem;
  }

  .action-buttons {
    gap: 0.5rem;
  }

  .action-buttons button {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
  }

  form {
    padding: 1rem;
  }

  .form-container {
    max-width: 100%;
  }

  .form-actions {
    flex-direction: column;
  }

  .form-actions button {
    width: 100%;
  }

  .form-inline {
    flex-direction: column;
    align-items: stretch;
  }

  .form-inline .form-group {
    width: 100%;
  }

  button {
    width: 100%;
    margin-bottom: 0.5rem;
  }

  .table-container {
    margin: 1rem 0;
  }

  table,
  .data-table {
    font-size: 0.8rem;
  }

  th, td {
    padding: 0.5rem 0.375rem;
  }

  .actions-column button {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  .filters-container {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-group select {
    min-width: 100%;
  }
}

@media (max-width: 480px) {
  .page-content,
  .page-container {
    padding: 10px;
  }

  .page-title {
    font-size: 20px;
  }

  .section {
    padding: 12px;
  }

  .header-nav {
    gap: 0.75rem;
  }

  .header-nav a {
    font-size: 0.85rem;
  }

  h1 {
    font-size: 1.5rem;
  }

  .item-name {
    font-size: 1.25rem;
  }

  form {
    padding: 0.75rem;
  }

  input[type="text"],
  input[type="email"],
  input[type="password"],
  input[type="date"],
  input[type="datetime-local"],
  select,
  textarea {
    font-size: 16px;
  }
}

.dashboard-hero {
  background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
  color: #fff;
  padding: 20px 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0, 102, 204, 0.2);
}

.hero-welcome {
  font-size: 24px;
  font-weight: 600;
  margin: 0 0 6px 0;
  color: #fff;
}

.hero-date {
  font-size: 14px;
  margin: 0 0 4px 0;
  opacity: 0.9;
}

.hero-tagline {
  font-size: 15px;
  margin: 0;
  font-weight: 500;
  opacity: 0.95;
}

.dashboard-stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}

.dashboard-stat-card {
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  text-align: center;
  transition: transform 0.2s, box-shadow 0.2s;
}

.dashboard-stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.stat-number {
  font-size: 28px;
  font-weight: 700;
  color: #333;
  margin: 6px 0;
  line-height: 1;
}

.stat-label {
  font-size: 13px;
  font-weight: 600;
  color: #555;
  margin: 6px 0 3px 0;
}

.stat-subtext {
  font-size: 11px;
  color: #999;
}

.section-link {
  color: #0066cc;
  font-size: 14px;
  font-weight: 500;
  text-decoration: none;
  transition: color 0.2s;
}

.section-link:hover {
  color: #0052a3;
  text-decoration: none;
}

.next-up-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.next-up-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
  transition: background 0.2s;
}

.next-up-item:hover {
  background: #f3f4f6;
}

.next-up-content {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.next-up-number {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #0066cc;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 13px;
  flex-shrink: 0;
}

.next-up-details {
  flex: 1;
}

.next-up-name {
  font-size: 15px;
  font-weight: 600;
  color: #333;
  margin-bottom: 3px;
}

.next-up-project {
  font-size: 12px;
  color: #666;
}

.empty-state-small {
  padding: 24px;
  text-align: center;
  color: #999;
  font-style: italic;
}

.dashboard-projects-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}

.dashboard-project-card {
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  border-left: 3px solid #0066cc;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.dashboard-project-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.project-card-name {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin: 0 0 10px 0;
}

.project-card-priority {
  color: #fbbf24;
  font-size: 14px;
  margin-bottom: 10px;
}

.project-card-progress-bar {
  width: 100%;
  height: 6px;
  background: #e5e7eb;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 10px;
}

.project-card-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #0066cc, #3b82f6);
  transition: width 0.3s ease;
}

.project-card-stats {
  font-size: 12px;
  color: #666;
  margin-bottom: 3px;
}

.project-card-link {
  display: inline-block;
  margin-top: 10px;
  color: #0066cc;
  font-size: 13px;
  font-weight: 500;
  text-decoration: none;
  transition: color 0.2s;
}

.project-card-link:hover {
  color: #0052a3;
  text-decoration: none;
}

.recent-activity-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.recent-activity-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: #f9fafb;
  border-radius: 6px;
  border-left: 3px solid #28a745;
}

.activity-icon {
  font-size: 18px;
  flex-shrink: 0;
}

.activity-text {
  flex: 1;
  font-size: 13px;
  color: #333;
}

.activity-time {
  font-size: 11px;
  color: #999;
  flex-shrink: 0;
}

.dashboard-quick-actions {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}

.dashboard-action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px 20px;
  border-radius: 8px;
  text-decoration: none;
  transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.dashboard-action-primary {
  background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
  color: #fff;
}

.dashboard-action-primary:hover {
  background: linear-gradient(135deg, #0052a3 0%, #004080 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
  text-decoration: none;
  color: #fff;
}

.dashboard-action-secondary {
  background: #fff;
  color: #333;
  border: 2px solid #e5e7eb;
}

.dashboard-action-secondary:hover {
  border-color: #0066cc;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
  text-decoration: none;
  color: #0066cc;
}

.action-icon {
  font-size: 32px;
  margin-bottom: 10px;
}

.action-text {
  font-size: 15px;
  font-weight: 600;
}

@media (max-width: 768px) {
  .dashboard-stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .dashboard-projects-grid {
    grid-template-columns: 1fr;
  }

  .dashboard-quick-actions {
    grid-template-columns: 1fr;
  }

  .hero-welcome {
    font-size: 20px;
  }

  .hero-date {
    font-size: 13px;
  }

  .hero-tagline {
    font-size: 14px;
  }

  .stat-number {
    font-size: 24px;
  }

  .stat-icon {
    font-size: 28px;
  }
}

@media (max-width: 480px) {
  .dashboard-stats-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .dashboard-hero {
    padding: 16px 14px;
  }

  .hero-welcome {
    font-size: 18px;
  }

  .hero-date {
    font-size: 12px;
  }

  .hero-tagline {
    font-size: 13px;
  }

  .next-up-content {
    gap: 10px;
  }

  .next-up-number {
    width: 26px;
    height: 26px;
    font-size: 12px;
  }

  .next-up-name {
    font-size: 14px;
  }

  .next-up-project {
    font-size: 11px;
  }

  .activity-text {
    font-size: 12px;
  }

  .activity-time {
    font-size: 10px;
  }

  .dashboard-stat-card {
    padding: 14px;
  }

  .stat-number {
    font-size: 22px;
  }

  .stat-icon {
    font-size: 26px;
  }

  .elegant-form-row {
    flex-direction: column;
  }

  .elegant-form-field {
    flex: 1 1 100%;
  }

  .elegant-form-field-small {
    flex: 1 1 100%;
  }
}

.elegant-add-form {
  background: transparent;
  padding: 0;
  margin: 0;
  border-radius: 0;
  box-shadow: none;
}

.elegant-form-row {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
}

.elegant-form-field {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.elegant-form-field-small {
  flex: 0 0 200px;
}

.elegant-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 600;
  color: #555;
  margin-bottom: 6px;
}

.elegant-input {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s ease;
  background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
  color: #374151;
  font-weight: 500;
  appearance: none;
}

.elegant-input:focus {
  outline: none;
  border-color: #0066cc;
  background: #ffffff;
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1), 0 1px 3px rgba(0, 0, 0, 0.05);
}

.elegant-input:hover {
  border-color: #9ca3af;
  background: #ffffff;
}

.elegant-input::placeholder {
  color: #9ca3af;
  font-style: italic;
  font-weight: 500;
}

.custom-select-wrapper {
  position: relative;
  width: 100%;
}

.elegant-select {
  width: 100%;
  padding: 10px 40px 10px 14px;
  border: 1.5px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s ease;
  background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
  cursor: pointer;
  appearance: none;
  color: #374151;
  font-weight: 500;
}

.elegant-select:focus {
  outline: none;
  border-color: #0066cc;
  background: #ffffff;
  box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1), 0 1px 3px rgba(0, 0, 0, 0.05);
}

.elegant-select:hover {
  border-color: #9ca3af;
  background: #ffffff;
}

.elegant-select option {
  padding: 10px;
  font-weight: 500;
  color: #374151;
}

.elegant-select option[value=""] {
  color: #6b7280;
}

.elegant-select option[value="new"] {
  color: #0066cc;
  font-weight: 600;
}

.select-arrow {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: #6b7280;
  font-size: 11px;
  transition: color 0.2s;
}

.custom-select-wrapper:hover .select-arrow {
  color: #374151;
}

.elegant-new-project-section {
  background: #f0f7ff;
  padding: 16px;
  border-radius: 8px;
  border-left: 3px solid #0066cc;
  margin-bottom: 16px;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.elegant-form-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 16px;
}

.elegant-submit-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 20px;
  background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 8px rgba(0, 102, 204, 0.25);
}

.elegant-submit-btn:hover {
  background: linear-gradient(135deg, #0052a3 0%, #004080 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 102, 204, 0.35);
}

.elegant-submit-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(0, 102, 204, 0.25);
}

.elegant-submit-btn .btn-icon {
  font-size: 16px;
  font-weight: 400;
}

.badge {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  font-size: 0.75rem;
  font-weight: 600;
  line-height: 1;
  text-align: center;
  white-space: nowrap;
  vertical-align: baseline;
  border-radius: 4px;
}

.badge-primary {
  background-color: #0066cc;
  color: #fff;
}

.badge-success {
  background-color: #28a745;
  color: #fff;
}

.badge-warning {
  background-color: #ffc107;
  color: #212529;
}

.badge-danger {
  background-color: #dc3545;
  color: #fff;
}

.btn-sm {
  padding: 0.4rem 0.8rem;
  font-size: 0.875rem;
  border-radius: 6px;
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from 'next';
import { headers } from 'next/headers';
import './globals.css';
import LayoutWrapper from './components/LayoutWrapper';

export const metadata: Metadata = {
  title: 'Elephant App',
  description: 'Task and Project Management Application',
};

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const headersList = await headers();
  const pathname = headersList.get('x-pathname') || '/';

  return (
    <html lang="en">
      <body>
        <LayoutWrapper pathname={pathname}>{children}</LayoutWrapper>
      </body>
    </html>
  );
}
</file>

<file path="app/page.tsx">
import { redirect } from 'next/navigation';

export default function Home() {
  redirect('/dashboard');
}
</file>

<file path="components/AddItemForm.tsx">
'use client';

import { useState, useTransition } from 'react';

interface Project {
  id: string;
  name: string;
}

interface AddItemFormProps {
  projects: Project[];
  onSubmit: (formData: FormData) => void;
}

export default function AddItemForm({ projects, onSubmit }: AddItemFormProps) {
  const [showNewProject, setShowNewProject] = useState(false);
  const [isPending, startTransition] = useTransition();

  const handleProjectChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setShowNewProject(e.target.value === 'new');
  };

  const handleSubmit = async (formData: FormData) => {
    startTransition(async () => {
      await onSubmit(formData);
    });
  };

  return (
    <form action={handleSubmit} className="elegant-add-form">
      <div className="elegant-form-row">
        <div className="elegant-form-field">
          <label htmlFor="name" className="elegant-label">
            Item Name
          </label>
          <input 
            id="name" 
            name="name" 
            type="text" 
            required 
            placeholder="What do you need to do?" 
            className="elegant-input"
            disabled={isPending}
          />
        </div>
        
        <div className="elegant-form-field">
          <label htmlFor="project_select" className="elegant-label">
            Project
          </label>
          <div className="custom-select-wrapper">
            <select 
              id="project_select" 
              name="project_select" 
              onChange={handleProjectChange}
              className="elegant-select"
              disabled={isPending}
            >
              <option value="">None (Errand)</option>
              {projects?.map((project) => (
                <option key={project.id} value={project.id}>
                  {project.name}
                </option>
              ))}
              <option value="new">+ Create New Project</option>
            </select>
            <span className="select-arrow">‚ñº</span>
          </div>
        </div>
      </div>

      {showNewProject && (
        <div className="elegant-new-project-section">
          <div className="elegant-form-row">
            <div className="elegant-form-field">
              <label htmlFor="new_project_name" className="elegant-label">
                New Project Name
              </label>
              <input 
                id="new_project_name" 
                name="new_project_name" 
                type="text" 
                required={showNewProject} 
                placeholder="Enter project name" 
                className="elegant-input"
                disabled={isPending}
              />
            </div>
            
            <div className="elegant-form-field elegant-form-field-small">
              <label htmlFor="new_project_priority" className="elegant-label">
                Priority
              </label>
              <div className="custom-select-wrapper">
                <select 
                  id="new_project_priority" 
                  name="new_project_priority" 
                  defaultValue="3"
                  className="elegant-select"
                  disabled={isPending}
                >
                  <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Highest</option>
                  <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ High</option>
                  <option value="3">‚òÖ‚òÖ‚òÖ Medium</option>
                  <option value="2">‚òÖ‚òÖ Low</option>
                  <option value="1">‚òÖ Lowest</option>
                </select>
                <span className="select-arrow">‚ñº</span>
              </div>
            </div>
          </div>
        </div>
      )}

      <div className="elegant-form-actions">
        <button 
          type="submit" 
          className="elegant-submit-btn"
          disabled={isPending}
          style={{ cursor: isPending ? 'wait' : 'pointer' }}
        >
          <span className="btn-icon">+</span>
          {isPending ? 'Adding...' : 'Add Item'}
        </button>
      </div>
    </form>
  );
}
</file>

<file path="components/CompletedFilters.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { useState } from 'react';

interface CompletedFiltersProps {
  currentDateFilter: string;
  currentTypeFilter: string;
}

export default function CompletedFilters({ currentDateFilter, currentTypeFilter }: CompletedFiltersProps) {
  const router = useRouter();
  const [dateFilter, setDateFilter] = useState(currentDateFilter);
  const [typeFilter, setTypeFilter] = useState(currentTypeFilter);

  const handleApply = () => {
    const params = new URLSearchParams();
    if (dateFilter !== 'all') params.set('dateFilter', dateFilter);
    if (typeFilter !== 'all') params.set('typeFilter', typeFilter);
    router.push(`/completed?${params.toString()}`);
  };

  return (
    <div className="filters-container">
      <div className="filter-group">
        <label htmlFor="dateFilter">Date Range:</label>
        <select
          id="dateFilter"
          value={dateFilter}
          onChange={(e) => setDateFilter(e.target.value)}
        >
          <option value="all">All time</option>
          <option value="7days">Last 7 days</option>
          <option value="30days">Last 30 days</option>
        </select>
      </div>

      <div className="filter-group">
        <label htmlFor="typeFilter">Type:</label>
        <select
          id="typeFilter"
          value={typeFilter}
          onChange={(e) => setTypeFilter(e.target.value)}
        >
          <option value="all">All</option>
          <option value="errands">Errands Only</option>
          <option value="projects">Project Items Only</option>
        </select>
      </div>

      <button type="button" onClick={handleApply} className="btn-primary">
        Apply Filters
      </button>
    </div>
  );
}
</file>

<file path="components/ExportDatabaseForm.tsx">
'use client';

import { useState } from 'react';

interface ExportDatabaseFormProps {
  userId: string;
}

export default function ExportDatabaseForm({ userId }: ExportDatabaseFormProps) {
  const [isExporting, setIsExporting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleExport = async () => {
    setIsExporting(true);
    setError(null);

    try {
      const response = await fetch('/api/export', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Export failed');
      }

      const data = await response.json();
      
      const jsonString = JSON.stringify(data.data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `elephant-app-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Export failed');
    } finally {
      setIsExporting(false);
    }
  };

  return (
    <div>
      <button
        type="button"
        onClick={handleExport}
        disabled={isExporting}
        className="btn-secondary"
      >
        {isExporting ? 'Exporting...' : 'Export Database'}
      </button>
      {error && (
        <div style={{ 
          padding: '0.5rem', 
          marginTop: '0.5rem', 
          backgroundColor: '#fee', 
          border: '1px solid #fcc', 
          borderRadius: '4px', 
          color: '#c33',
          fontSize: '0.875rem'
        }}>
          {error}
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/ImportDatabaseForm.tsx">
'use client';

interface ImportDatabaseFormProps {
  onSubmit: (formData: FormData) => void;
}

export default function ImportDatabaseForm({ onSubmit }: ImportDatabaseFormProps) {
  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    if (!confirm('This will replace all your current data. Are you sure?')) {
      e.preventDefault();
      return;
    }
  };

  return (
    <form action={onSubmit} onSubmit={handleSubmit}>
      <div className="form-group">
        <label htmlFor="import_file">Import Database (JSON file)</label>
        <input id="import_file" name="file" type="file" accept=".json" required />
      </div>
      <div className="form-actions">
        <button type="submit" className="btn-warning">Import Database</button>
      </div>
    </form>
  );
}
</file>

<file path="components/ProjectActions.tsx">
'use client';

import { useState } from 'react';

interface ProjectActionsProps {
  projectId: string;
  projectName: string;
  onComplete: (projectId: string) => Promise<void>;
  onDelete: (projectId: string) => Promise<void>;
}

export default function ProjectActions({ 
  projectId, 
  projectName, 
  onComplete, 
  onDelete 
}: ProjectActionsProps) {
  const [isProcessing, setIsProcessing] = useState(false);

  const handleComplete = async () => {
    setIsProcessing(true);
    await onComplete(projectId);
  };

  const handleDelete = async () => {
    if (confirm(`Are you sure you want to delete "${projectName}"? This will delete the project and all Active/Inactive items (Completed items will be preserved).`)) {
      setIsProcessing(true);
      await onDelete(projectId);
    }
  };

  return (
    <>
      <button
        type="button"
        onClick={handleComplete}
        className="btn-success"
        disabled={isProcessing}
        title="Complete all Active/Inactive items"
        style={{ cursor: isProcessing ? 'wait' : 'pointer' }}
      >
        {isProcessing ? 'Processing...' : 'Complete'}
      </button>
      <button
        type="button"
        onClick={handleDelete}
        className="btn-danger"
        disabled={isProcessing}
        title="Delete project and all Active/Inactive items"
        style={{ cursor: isProcessing ? 'wait' : 'pointer' }}
      >
        {isProcessing ? 'Deleting...' : 'Delete'}
      </button>
    </>
  );
}
</file>

<file path="components/ProjectItemsSection.tsx">
'use client';

import { useState } from 'react';

interface ProjectItem {
  id: string;
  name: string;
  dateCompleted: string;
  sequence: number;
}

interface ProjectGroup {
  projectId: string;
  projectName: string;
  items: ProjectItem[];
}

interface ProjectItemsSectionProps {
  projectGroups: ProjectGroup[];
}

function formatDateTime(dateString: string | null) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${month}/${day}/${year} ${hours}:${minutes}`;
}

export default function ProjectItemsSection({ projectGroups }: ProjectItemsSectionProps) {
  const [expandedProjects, setExpandedProjects] = useState<Set<string>>(new Set());

  const toggleProject = (projectId: string) => {
    setExpandedProjects((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(projectId)) {
        newSet.delete(projectId);
      } else {
        newSet.add(projectId);
      }
      return newSet;
    });
  };

  return (
    <div className="project-items-container">
      {projectGroups.map((group) => {
        const isExpanded = expandedProjects.has(group.projectId);
        return (
          <div key={group.projectId} className="project-group">
            <div
              className="project-header"
              onClick={() => toggleProject(group.projectId)}
            >
              <span className="expand-icon">{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
              <span className="project-name">{group.projectName}</span>
              <span className="item-count">({group.items.length} items)</span>
            </div>
            {isExpanded && (
              <div className="project-items">
                <div className="table-container">
                  <table className="data-table">
                    <thead>
                      <tr>
                        <th>Item Name</th>
                        <th>Date Completed</th>
                        <th>Sequence</th>
                      </tr>
                    </thead>
                    <tbody>
                      {group.items.map((item) => (
                        <tr key={item.id}>
                          <td>{item.name}</td>
                          <td>{formatDateTime(item.dateCompleted)}</td>
                          <td>{item.sequence}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="components/ResetAppForm.tsx">
'use client';

interface ResetAppFormProps {
  onSubmit: () => void;
}

export default function ResetAppForm({ onSubmit }: ResetAppFormProps) {
  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    if (!confirm('This will delete ALL your data permanently. Are you absolutely sure?')) {
      e.preventDefault();
      return;
    }
  };

  return (
    <form action={onSubmit} onSubmit={handleSubmit}>
      <div className="form-actions">
        <button type="submit" className="btn-danger">
          Reset App (Full Reset)
        </button>
      </div>
    </form>
  );
}
</file>

<file path="lib/actions/auth.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { revalidatePath } from 'next/cache';
import { redirect } from 'next/navigation';

export async function signUp(formData: FormData) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const authData = {
    email: formData.get('email') as string,
    password: formData.get('password') as string,
  };

  const { data, error } = await supabase.auth.signUp(authData);

  if (error) {
    redirect('/auth/signup?error=' + encodeURIComponent(error.message));
  }

  if (data.user) {
    const profileData = {
      id: data.user.id,
      username: formData.get('username') as string || null,
      first_name: formData.get('first_name') as string || null,
      last_name: formData.get('last_name') as string || null,
      birthdate: formData.get('birthdate') as string || null,
      gender: formData.get('gender') as string || null,
      show_master_list: false,
    };

    const { error: profileError } = await adminClient
      .from('profiles')
      .insert(profileData);

    if (profileError) {
      redirect('/auth/signup?error=' + encodeURIComponent(profileError.message));
    }
  }

  revalidatePath('/', 'layout');
  redirect('/dashboard');
}

export async function signIn(formData: FormData) {
  const supabase = await createClient();

  const data = {
    email: formData.get('email') as string,
    password: formData.get('password') as string,
  };

  const { error } = await supabase.auth.signInWithPassword(data);

  if (error) {
    redirect('/auth/login?error=' + encodeURIComponent(error.message));
  }

  revalidatePath('/', 'layout');
  redirect('/dashboard');
}

export async function signOut() {
  const supabase = await createClient();
  await supabase.auth.signOut();
  revalidatePath('/', 'layout');
  redirect('/auth/login');
}

export async function requestPasswordReset(formData: FormData) {
  const supabase = await createClient();

  const email = formData.get('email') as string;

  if (!email) {
    redirect('/auth/forgot-password?error=' + encodeURIComponent('Email is required'));
  }

  const origin = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000';

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: `${origin}/auth/callback?next=/auth/update-password`,
  });

  if (error) {
    redirect('/auth/forgot-password?error=' + encodeURIComponent(error.message));
  }

  redirect('/auth/forgot-password?success=' + encodeURIComponent('Password reset link has been sent to your email'));
}
</file>

<file path="lib/actions/lists.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { revalidatePath } from 'next/cache';
import { cookies } from 'next/headers';
import type { List } from '@/types';

const CURRENT_LIST_COOKIE = 'elephant_current_list_id';

export async function getCurrentListId(): Promise<string | null> {
  const supabase = await createClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return null;
  }

  const cookieStore = await cookies();
  const savedListId = cookieStore.get(CURRENT_LIST_COOKIE)?.value;

  if (savedListId) {
    const { data: list } = await supabase
      .from('lists')
      .select('id')
      .eq('id', savedListId)
      .eq('user_id', user.id)
      .single();

    if (list) {
      return savedListId;
    }
  }

  const { data: defaultList } = await supabase
    .from('lists')
    .select('id')
    .eq('user_id', user.id)
    .eq('is_default', true)
    .single();

  if (defaultList) {
    return defaultList.id;
  }

  const { data: firstList } = await supabase
    .from('lists')
    .select('id')
    .eq('user_id', user.id)
    .order('created_at', { ascending: true })
    .limit(1)
    .single();

  return firstList?.id || null;
}

export async function setCurrentListId(listId: string) {
  const cookieStore = await cookies();
  cookieStore.set(CURRENT_LIST_COOKIE, listId, {
    path: '/',
    maxAge: 60 * 60 * 24 * 365,
    sameSite: 'lax',
    secure: process.env.NODE_ENV === 'production',
  });

  revalidatePath('/', 'layout');
}

export async function getLists() {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: [], error: 'Unauthorized' };
  }

  const { data, error } = await supabase
    .from('lists')
    .select('*')
    .eq('user_id', user.id)
    .order('is_default', { ascending: false })
    .order('created_at', { ascending: true });

  if (error) {
    return { data: [], error: error.message };
  }

  return { data: data as List[], error: null };
}

export async function getListById(listId: string) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: null, error: 'Unauthorized' };
  }

  const { data, error } = await supabase
    .from('lists')
    .select('*')
    .eq('id', listId)
    .eq('user_id', user.id)
    .single();

  if (error) {
    return { data: null, error: error.message };
  }

  return { data: data as List, error: null };
}

export async function createList(name: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { success: false, error: 'Unauthorized', listId: null };
  }

  if (!name || name.trim() === '') {
    return { success: false, error: 'List name is required', listId: null };
  }

  const { data: existingList } = await adminClient
    .from('lists')
    .select('id')
    .eq('user_id', user.id)
    .eq('name', name.trim())
    .single();

  if (existingList) {
    return { success: false, error: 'A list with this name already exists', listId: null };
  }

  const { data: hasLists } = await adminClient
    .from('lists')
    .select('id')
    .eq('user_id', user.id)
    .limit(1)
    .single();

  const isFirstList = !hasLists;

  const { data: newList, error } = await adminClient
    .from('lists')
    .insert({
      user_id: user.id,
      name: name.trim(),
      is_default: isFirstList,
    })
    .select('id')
    .single();

  if (error) {
    return { success: false, error: error.message, listId: null };
  }

  revalidatePath('/', 'layout');

  return { success: true, error: null, listId: newList.id };
}

export async function updateList(listId: string, name: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { success: false, error: 'Unauthorized' };
  }

  if (!name || name.trim() === '') {
    return { success: false, error: 'List name is required' };
  }

  const { data: list } = await adminClient
    .from('lists')
    .select('id')
    .eq('id', listId)
    .eq('user_id', user.id)
    .single();

  if (!list) {
    return { success: false, error: 'List not found' };
  }

  const { data: existingList } = await adminClient
    .from('lists')
    .select('id')
    .eq('user_id', user.id)
    .eq('name', name.trim())
    .neq('id', listId)
    .single();

  if (existingList) {
    return { success: false, error: 'A list with this name already exists' };
  }

  const { error } = await adminClient
    .from('lists')
    .update({ name: name.trim() })
    .eq('id', listId)
    .eq('user_id', user.id);

  if (error) {
    return { success: false, error: error.message };
  }

  revalidatePath('/', 'layout');

  return { success: true, error: null };
}

export async function deleteList(listId: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { success: false, error: 'Unauthorized' };
  }

  const { data: list } = await adminClient
    .from('lists')
    .select('is_default')
    .eq('id', listId)
    .eq('user_id', user.id)
    .single();

  if (!list) {
    return { success: false, error: 'List not found' };
  }

  if (list.is_default) {
    return { success: false, error: 'Cannot delete the default list' };
  }

  const { error } = await adminClient
    .from('lists')
    .delete()
    .eq('id', listId)
    .eq('user_id', user.id);

  if (error) {
    return { success: false, error: error.message };
  }

  const cookieStore = await cookies();
  const currentListId = cookieStore.get(CURRENT_LIST_COOKIE)?.value;

  if (currentListId === listId) {
    const { data: defaultList } = await adminClient
      .from('lists')
      .select('id')
      .eq('user_id', user.id)
      .eq('is_default', true)
      .single();

    if (defaultList) {
      await setCurrentListId(defaultList.id);
    }
  }

  revalidatePath('/', 'layout');

  return { success: true, error: null };
}

export async function ensureUserHasDefaultList() {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { success: false, listId: null };
  }

  const { data: defaultList } = await adminClient
    .from('lists')
    .select('id')
    .eq('user_id', user.id)
    .eq('is_default', true)
    .single();

  if (defaultList) {
    return { success: true, listId: defaultList.id };
  }

  const { data: newList, error } = await adminClient
    .from('lists')
    .insert({
      user_id: user.id,
      name: 'Master List',
      is_default: true,
    })
    .select('id')
    .single();

  if (error) {
    return { success: false, listId: null };
  }

  return { success: true, listId: newList.id };
}
</file>

<file path="lib/actions/profile.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import type { Profile } from '@/types';

export async function getProfile() {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: null, error: 'Unauthorized' };
  }

  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (error) {
    return { data: null, error: error.message };
  }

  return { data: data as Profile, error: null };
}

export async function updateProfile(formData: FormData) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  const data: Partial<Profile> = {
    username: formData.get('username') as string || null,
    first_name: formData.get('first_name') as string || null,
    last_name: formData.get('last_name') as string || null,
    birthdate: formData.get('birthdate') as string || null,
    gender: (formData.get('gender') as 'Male' | 'Female' | 'Other') || null,
    show_master_list: formData.get('show_master_list') === 'true',
  };

  await supabase
    .from('profiles')
    .update(data)
    .eq('id', user.id);

  revalidatePath('/settings');
}

export async function createProfile() {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  const { data: existingProfile } = await supabase
    .from('profiles')
    .select('id')
    .eq('id', user.id)
    .single();

  if (existingProfile) {
    return;
  }

  await supabase.from('profiles').insert({
    id: user.id,
    show_master_list: false,
  });

  revalidatePath('/settings');
}
</file>

<file path="lib/actions/project-items.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import type { ProjectItemLink } from '@/types';

export async function linkItemToProject(projectId: string, itemId: string, sequence: number) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  await supabase.from('project_item_links').insert({
    project_id: projectId,
    item_id: itemId,
    sequence,
  });

  revalidatePath('/projects');
}

export async function unlinkItemFromProject(linkId: string) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  await supabase
    .from('project_item_links')
    .delete()
    .eq('id', linkId);

  revalidatePath('/projects');
}

export async function getProjectItems(projectId: string) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: [], error: 'Unauthorized' };
  }

  const { data, error } = await supabase
    .from('project_item_links')
    .select(`
      *,
      items (*)
    `)
    .eq('project_id', projectId)
    .order('sequence', { ascending: true });

  if (error) {
    return { data: [], error: error.message };
  }

  return { data: data as any[], error: null };
}

export async function reorderProjectItems(items: { id: string; sequence: number }[]) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  for (const item of items) {
    await supabase
      .from('project_item_links')
      .update({ sequence: item.sequence })
      .eq('id', item.id);
  }

  revalidatePath('/projects');
}
</file>

<file path="lib/actions/projects.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { revalidatePath } from 'next/cache';
import { getActiveListId } from '@/lib/utils/list-context';
import type { Project } from '@/types';

export async function createProject(formData: FormData) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  const listId = await getActiveListId();
  const priority = parseInt(formData.get('priority') as string);
  
  const data = {
    user_id: user.id,
    list_id: listId,
    name: formData.get('name') as string,
    priority: priority >= 1 && priority <= 5 ? priority : 3,
    status: (formData.get('status') as 'Active' | 'Inactive' | 'Completed') || 'Active',
    due_date: formData.get('due_date') as string || null,
  };

  await supabase.from('projects').insert(data);

  revalidatePath('/projects');
}

export async function createNewProject(name: string, priority: number) {
  try {
    const supabase = await createClient();
    const adminClient = createAdminClient();

    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user) {
      return { success: false, error: 'Unauthorized' };
    }

    if (!name || name.trim() === '') {
      return { success: false, error: 'Project name is required' };
    }

    const listId = await getActiveListId();
    const validPriority = priority >= 1 && priority <= 5 ? priority : 3;

    const { data: newProject, error } = await adminClient
      .from('projects')
      .insert({
        user_id: user.id,
        list_id: listId,
        name: name.trim(),
        priority: validPriority,
        status: 'Active',
      })
      .select('id')
      .single();

    if (error) {
      return { success: false, error: `Failed to create project: ${error.message}` };
    }

    revalidatePath('/dashboard');
    revalidatePath('/projects');

    return { success: true, projectId: newProject.id };
  } catch (error) {
    return { success: false, error: error instanceof Error ? error.message : 'Unknown error occurred' };
  }
}

export async function updateProject(id: string, formData: FormData) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  const priority = parseInt(formData.get('priority') as string);

  const data: Partial<Project> = {
    name: formData.get('name') as string,
    priority: priority >= 1 && priority <= 5 ? (priority as 1 | 2 | 3 | 4 | 5) : undefined,
    status: formData.get('status') as 'Active' | 'Inactive' | 'Completed',
    due_date: formData.get('due_date') as string || null,
  };

  await supabase
    .from('projects')
    .update(data)
    .eq('id', id)
    .eq('user_id', user.id);

  revalidatePath('/projects');
}

export async function deleteProject(id: string) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  await supabase
    .from('projects')
    .delete()
    .eq('id', id)
    .eq('user_id', user.id);

  revalidatePath('/projects');
}

export async function getProjects() {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: [], error: 'Unauthorized' };
  }

  const listId = await getActiveListId();

  const { data, error } = await supabase
    .from('projects')
    .select('*')
    .eq('user_id', user.id)
    .eq('list_id', listId)
    .order('priority', { ascending: false });

  if (error) {
    return { data: [], error: error.message };
  }

  return { data: data as Project[], error: null };
}

export async function updateProjectName(projectId: string, name: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const { error } = await adminClient
    .from('projects')
    .update({ name })
    .eq('id', projectId)
    .eq('user_id', user.id);

  if (error) {
    throw new Error(error.message);
  }

  revalidatePath('/projects');
  revalidatePath(`/projects/${projectId}`);
  
  return { success: true };
}

export async function updateProjectPriority(projectId: string, priority: number) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const validPriority = priority >= 1 && priority <= 5 ? priority : 3;

  const { error } = await adminClient
    .from('projects')
    .update({ priority: validPriority })
    .eq('id', projectId)
    .eq('user_id', user.id);

  if (error) {
    throw new Error(error.message);
  }

  revalidatePath('/projects');
  revalidatePath(`/projects/${projectId}`);
  
  return { success: true };
}

export async function updateItemSequence(projectId: string, itemId: string, direction: 'up' | 'down') {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const { data: currentLink } = await adminClient
    .from('project_item_links')
    .select('id, sequence')
    .eq('project_id', projectId)
    .eq('item_id', itemId)
    .single();

  if (!currentLink) {
    throw new Error('Item link not found');
  }

  const targetSequence = direction === 'up' ? currentLink.sequence - 1 : currentLink.sequence + 1;

  const { data: adjacentLink } = await adminClient
    .from('project_item_links')
    .select('id, sequence')
    .eq('project_id', projectId)
    .eq('sequence', targetSequence)
    .single();

  if (!adjacentLink) {
    return { success: false };
  }

  const tempSequence = -1;

  await adminClient
    .from('project_item_links')
    .update({ sequence: tempSequence })
    .eq('id', currentLink.id);

  await adminClient
    .from('project_item_links')
    .update({ sequence: currentLink.sequence })
    .eq('id', adjacentLink.id);

  await adminClient
    .from('project_item_links')
    .update({ sequence: adjacentLink.sequence })
    .eq('id', currentLink.id);

  revalidatePath(`/projects/${projectId}`);
  revalidatePath('/master-list');
  revalidatePath('/do-now');
  
  return { success: true };
}

export async function deleteProjectItem(itemId: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();
  const { reindexMasterList } = await import('@/lib/utils/masterlist');

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  await adminClient
    .from('master_list')
    .delete()
    .eq('item_id', itemId);

  await adminClient
    .from('project_item_links')
    .delete()
    .eq('item_id', itemId);

  await adminClient
    .from('items')
    .delete()
    .eq('id', itemId)
    .eq('user_id', user.id);

  await reindexMasterList(user.id);

  revalidatePath('/projects');
  revalidatePath('/master-list');
  revalidatePath('/do-now');
  
  return { success: true };
}

export async function updateItemName(itemId: string, name: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const { error } = await adminClient
    .from('items')
    .update({ name })
    .eq('id', itemId)
    .eq('user_id', user.id);

  if (error) {
    throw new Error(error.message);
  }

  revalidatePath('/projects');
  revalidatePath('/master-list');
  revalidatePath('/do-now');
  
  return { success: true };
}
</file>

<file path="lib/actions/settings.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { revalidatePath } from 'next/cache';

export async function toggleMasterList(userId: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user || user.id !== userId) {
    throw new Error('Unauthorized');
  }

  const { data: profile } = await adminClient
    .from('profiles')
    .select('show_master_list')
    .eq('id', userId)
    .single();

  const newValue = !profile?.show_master_list;

  await adminClient
    .from('profiles')
    .update({ show_master_list: newValue })
    .eq('id', userId);

  revalidatePath('/settings');
  revalidatePath('/dashboard');
}

export async function exportDatabase(userId: string) {
  try {
    const supabase = await createClient();
    const adminClient = createAdminClient();

    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user || user.id !== userId) {
      return { success: false, error: 'Unauthorized' };
    }

    const { data: projects, error: projectsError } = await adminClient
      .from('projects')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: true });

    if (projectsError) {
      return { success: false, error: `Failed to fetch projects: ${projectsError.message}` };
    }

    const { data: items, error: itemsError } = await adminClient
      .from('items')
      .select('*')
      .eq('user_id', userId)
      .order('date_added', { ascending: true });

    if (itemsError) {
      return { success: false, error: `Failed to fetch items: ${itemsError.message}` };
    }

    const { data: projectLinks, error: linksError } = await adminClient
      .from('project_item_links')
      .select('*')
      .order('sequence', { ascending: true });

    if (linksError) {
      return { success: false, error: `Failed to fetch project links: ${linksError.message}` };
    }

    const { data: masterList, error: masterListError } = await adminClient
      .from('master_list')
      .select('*')
      .eq('user_id', userId)
      .order('position', { ascending: true });

    if (masterListError) {
      return { success: false, error: `Failed to fetch master list: ${masterListError.message}` };
    }

    const exportProjects = (projects || []).map((project: any) => {
      const itemIds = (projectLinks || [])
        .filter((link: any) => link.project_id === project.id)
        .sort((a: any, b: any) => a.sequence - b.sequence)
        .map((link: any) => link.item_id);

      return {
        projectId: project.id,
        name: project.name,
        priority: project.priority,
        status: project.status,
        createDate: project.created_at,
        dueDate: project.due_date,
        itemIds,
      };
    });

    const exportItems = (items || []).map((item: any) => ({
      itemId: item.id,
      projectId: item.project_id,
      name: item.name,
      status: item.status,
      type: item.type,
      dateAdded: item.date_added,
      dateCompleted: item.date_completed,
    }));

    const exportMasterList = (masterList || []).map((entry: any) => {
      if (entry.item_id) {
        return {
          type: 'Errand',
          itemId: entry.item_id,
        };
      } else if (entry.project_placeholder_id) {
        const lastDashIndex = entry.project_placeholder_id.lastIndexOf('-');
        const projectId = entry.project_placeholder_id.substring(0, lastDashIndex);
        const index = parseInt(entry.project_placeholder_id.substring(lastDashIndex + 1));
        return {
          type: 'ProjectPlaceholder',
          projectId,
          placeholderIndex: isNaN(index) ? 1 : index,
        };
      }
      return null;
    }).filter(Boolean);

    return {
      success: true,
      data: {
        projects: exportProjects,
        items: exportItems,
        masterList: exportMasterList,
      },
    };
  } catch (error) {
    return { success: false, error: error instanceof Error ? error.message : 'Export failed' };
  }
}

export async function importDatabase(userId: string, jsonData: string) {
  try {
    const supabase = await createClient();
    const adminClient = createAdminClient();

    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user || user.id !== userId) {
      return { success: false, error: 'Unauthorized' };
    }

    let data;
    try {
      data = JSON.parse(jsonData);
    } catch {
      return { success: false, error: 'Invalid JSON format' };
    }

    if (!data.projects || !Array.isArray(data.projects)) {
      return { success: false, error: 'Missing or invalid projects array' };
    }

    if (!data.items || !Array.isArray(data.items)) {
      return { success: false, error: 'Missing or invalid items array' };
    }

    if (!data.masterList || !Array.isArray(data.masterList)) {
      return { success: false, error: 'Missing or invalid masterList array' };
    }

    for (const project of data.projects) {
      if (!project.projectId || !project.name || !project.priority) {
        return { success: false, error: 'Invalid project structure' };
      }
    }

    for (const item of data.items) {
      if (!item.itemId || !item.name || !item.type || !item.status) {
        return { success: false, error: 'Invalid item structure' };
      }
    }

    const itemIds = new Set(data.items.map((item: any) => item.itemId));
    const projectIds = new Set(data.projects.map((project: any) => project.projectId));

    for (const project of data.projects) {
      if (project.itemIds && Array.isArray(project.itemIds)) {
        for (const itemId of project.itemIds) {
          if (!itemIds.has(itemId)) {
            return { success: false, error: `Invalid item reference in project: ${itemId}` };
          }
        }
      }
    }

    for (const entry of data.masterList) {
      if (entry.type === 'Errand') {
        if (!entry.itemId || !itemIds.has(entry.itemId)) {
          return { success: false, error: `Invalid item reference in master list: ${entry.itemId}` };
        }
      } else if (entry.type === 'ProjectPlaceholder') {
        if (!entry.projectId) {
          return { success: false, error: 'Missing project ID in master list entry' };
        }
        if (!projectIds.has(entry.projectId)) {
          return { success: false, error: `Invalid project reference in master list: ${entry.projectId}` };
        }
      } else {
        return { success: false, error: `Invalid master list entry type: ${entry.type}` };
      }
    }

    const { error: deleteMasterListError } = await adminClient
      .from('master_list')
      .delete()
      .eq('user_id', userId);

    if (deleteMasterListError) {
      return { success: false, error: `Failed to clear master list: ${deleteMasterListError.message}` };
    }

    const { data: existingProjects } = await adminClient
      .from('projects')
      .select('id')
      .eq('user_id', userId);

    if (existingProjects && existingProjects.length > 0) {
      const projectIdsToDelete = existingProjects.map((p: any) => p.id);
      await adminClient.from('project_item_links').delete().in('project_id', projectIdsToDelete);
    }

    const { error: deleteItemsError } = await adminClient
      .from('items')
      .delete()
      .eq('user_id', userId);

    if (deleteItemsError) {
      return { success: false, error: `Failed to clear items: ${deleteItemsError.message}` };
    }

    const { error: deleteProjectsError } = await adminClient
      .from('projects')
      .delete()
      .eq('user_id', userId);

    if (deleteProjectsError) {
      return { success: false, error: `Failed to clear projects: ${deleteProjectsError.message}` };
    }

    for (const project of data.projects) {
      const { error: projectError } = await adminClient.from('projects').insert({
        id: project.projectId,
        user_id: userId,
        name: project.name,
        priority: project.priority,
        status: project.status,
        created_at: project.createDate,
        due_date: project.dueDate,
      });

      if (projectError) {
        return { success: false, error: `Failed to import project: ${projectError.message}` };
      }
    }

    for (const item of data.items) {
      const { error: itemError } = await adminClient.from('items').insert({
        id: item.itemId,
        user_id: userId,
        project_id: item.projectId,
        name: item.name,
        status: item.status,
        type: item.type,
        date_added: item.dateAdded,
        date_completed: item.dateCompleted,
      });

      if (itemError) {
        return { success: false, error: `Failed to import item: ${itemError.message}` };
      }
    }

    for (const project of data.projects) {
      if (project.itemIds && Array.isArray(project.itemIds)) {
        let sequence = 1;
        for (const itemId of project.itemIds) {
          const { error: linkError } = await adminClient.from('project_item_links').insert({
            project_id: project.projectId,
            item_id: itemId,
            sequence,
          });

          if (linkError) {
            return { success: false, error: `Failed to link item to project: ${linkError.message}` };
          }
          sequence++;
        }
      }
    }

    let position = 1;
    for (const entry of data.masterList) {
      if (entry.type === 'Errand') {
        const { error: masterListError } = await adminClient.from('master_list').insert({
          user_id: userId,
          position,
          item_id: entry.itemId,
          project_placeholder_id: null,
        });

        if (masterListError) {
          return { success: false, error: `Failed to import master list entry: ${masterListError.message}` };
        }
      } else if (entry.type === 'ProjectPlaceholder') {
        const placeholderIndex = entry.placeholderIndex || 1;
        const { error: masterListError } = await adminClient.from('master_list').insert({
          user_id: userId,
          position,
          item_id: null,
          project_placeholder_id: `${entry.projectId}-${placeholderIndex}`,
        });

        if (masterListError) {
          return { success: false, error: `Failed to import master list entry: ${masterListError.message}` };
        }
      }
      position++;
    }

    revalidatePath('/settings');
    revalidatePath('/dashboard');
    revalidatePath('/projects');
    revalidatePath('/master-list');

    return { success: true };
  } catch (error) {
    return { success: false, error: error instanceof Error ? error.message : 'Import failed' };
  }
}

export async function resetApp(userId: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user || user.id !== userId) {
    throw new Error('Unauthorized');
  }

  await adminClient.from('master_list').delete().eq('user_id', userId);
  
  const { data: projects } = await adminClient
    .from('projects')
    .select('id')
    .eq('user_id', userId);

  if (projects && projects.length > 0) {
    const projectIds = projects.map((p: any) => p.id);
    await adminClient.from('project_item_links').delete().in('project_id', projectIds);
  }

  await adminClient.from('items').delete().eq('user_id', userId);
  await adminClient.from('projects').delete().eq('user_id', userId);

  revalidatePath('/settings');
  revalidatePath('/dashboard');
  revalidatePath('/projects');
  revalidatePath('/master-list');
}
</file>

<file path="lib/actions/tasks.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';

export async function createTask(formData: FormData) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  const data = {
    user_id: user.id,
    project_id: formData.get('project_id') as string || null,
    title: formData.get('title') as string,
    description: formData.get('description') as string || null,
    status: formData.get('status') as string || 'master-list',
    priority: parseInt(formData.get('priority') as string) || 0,
  };

  await supabase.from('tasks').insert(data);

  revalidatePath('/do-now');
  revalidatePath('/completed');
  revalidatePath('/master-list');
}

export async function updateTask(id: string, formData: FormData) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  const status = formData.get('status') as string;
  const data: any = {
    title: formData.get('title') as string,
    description: formData.get('description') as string || null,
    status,
    priority: parseInt(formData.get('priority') as string) || 0,
    updated_at: new Date().toISOString(),
  };

  if (status === 'completed') {
    data.completed_at = new Date().toISOString();
  }

  await supabase
    .from('tasks')
    .update(data)
    .eq('id', id)
    .eq('user_id', user.id);

  revalidatePath('/do-now');
  revalidatePath('/completed');
  revalidatePath('/master-list');
}

export async function deleteTask(id: string) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  await supabase
    .from('tasks')
    .delete()
    .eq('id', id)
    .eq('user_id', user.id);

  revalidatePath('/do-now');
  revalidatePath('/completed');
  revalidatePath('/master-list');
}

export async function getTasks(status?: string) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: [], error: 'Unauthorized' };
  }

  let query = supabase
    .from('tasks')
    .select('*')
    .eq('user_id', user.id);

  if (status) {
    query = query.eq('status', status);
  }

  const { data, error } = await query.order('priority', { ascending: false });

  if (error) {
    return { data: [], error: error.message };
  }

  return { data, error: null };
}
</file>

<file path="lib/supabase/admin.ts">
import { createClient } from '@supabase/supabase-js';

export function createAdminClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    }
  );
}
</file>

<file path="lib/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr';

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}
</file>

<file path="lib/supabase/server.ts">
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
          }
        },
      },
    }
  );
}
</file>

<file path="lib/utils/index.ts">
export function formatDate(date: string): string {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

export function formatDateTime(date: string): string {
  return new Date(date).toLocaleString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}
</file>

<file path="lib/utils/list-context.ts">
'use server';

import { getCurrentListId, ensureUserHasDefaultList } from '@/lib/actions/lists';

export async function getActiveListId(): Promise<string> {
  await ensureUserHasDefaultList();
  
  const listId = await getCurrentListId();
  
  if (!listId) {
    const { listId: defaultListId } = await ensureUserHasDefaultList();
    if (!defaultListId) {
      throw new Error('Failed to get or create default list');
    }
    return defaultListId;
  }
  
  return listId;
}
</file>

<file path="lib/utils/masterlist.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { getActiveListId } from '@/lib/utils/list-context';

export async function reindexMasterList(userId: string): Promise<void> {
  const adminClient = createAdminClient();
  const listId = await getActiveListId();

  const { data: entries } = await adminClient
    .from('master_list')
    .select('id')
    .eq('user_id', userId)
    .eq('list_id', listId)
    .order('position', { ascending: true });

  if (!entries || entries.length === 0) {
    return;
  }

  for (let i = 0; i < entries.length; i++) {
    await adminClient
      .from('master_list')
      .update({ position: i + 1 })
      .eq('id', entries[i].id)
      .eq('user_id', userId);
  }
}

export async function getTNML(userId: string): Promise<number> {
  const adminClient = createAdminClient();
  const listId = await getActiveListId();

  const { count } = await adminClient
    .from('master_list')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId)
    .eq('list_id', listId);

  return count || 0;
}

export async function getPLPI(userId: string, projectId: string): Promise<number> {
  const adminClient = createAdminClient();
  const listId = await getActiveListId();

  const { data: allPlaceholders } = await adminClient
    .from('master_list')
    .select('position, project_placeholder_id')
    .eq('user_id', userId)
    .eq('list_id', listId)
    .not('project_placeholder_id', 'is', null);

  if (!allPlaceholders || allPlaceholders.length === 0) {
    return 0;
  }

  let maxPosition = 0;

  for (const placeholder of allPlaceholders) {
    if (placeholder.project_placeholder_id) {
      const parts = placeholder.project_placeholder_id.split('-');
      const lastPart = parts[parts.length - 1];
      const extractedProjectId = parts.slice(0, -1).join('-');

      if (extractedProjectId === projectId && !isNaN(parseInt(lastPart))) {
        if (placeholder.position > maxPosition) {
          maxPosition = placeholder.position;
        }
      }
    }
  }

  return maxPosition;
}

export async function getNextInactiveProjectItem(projectId: string): Promise<string | null> {
  const adminClient = createAdminClient();

  const { data: links } = await adminClient
    .from('project_item_links')
    .select(`
      item_id,
      items (
        id,
        status
      )
    `)
    .eq('project_id', projectId)
    .order('sequence', { ascending: true });

  if (!links || links.length === 0) {
    return null;
  }

  for (const link of links) {
    const item = link.items as any;
    if (item && item.status === 'Inactive') {
      return item.id;
    }
  }

  return null;
}

export async function mapMasterListItem(masterListEntry: any): Promise<{
  itemName: string;
  projectName: string | null;
  projectId: string | null;
}> {
  const adminClient = createAdminClient();

  try {
    if (masterListEntry.item_id) {
      const { data: item } = await adminClient
        .from('items')
        .select('name, project_id, status, projects(name)')
        .eq('id', masterListEntry.item_id)
        .single();

      if (!item || item.status !== 'Active') {
        return { itemName: 'No Active Items', projectName: null, projectId: null };
      }

      const projectName = item.project_id && item.projects ? (item.projects as any).name : null;
      return { itemName: item.name, projectName, projectId: item.project_id };
    }

    if (masterListEntry.project_placeholder_id) {
      const parts = masterListEntry.project_placeholder_id.split('-');
      const projectId = parts.slice(0, -1).join('-');
      const placeholderIndex = parseInt(parts[parts.length - 1]);

      const { data: project } = await adminClient
        .from('projects')
        .select('name')
        .eq('id', projectId)
        .single();

      if (!project) {
        return { itemName: 'No Active Items', projectName: null, projectId: null };
      }

      const projectName = project.name;

      const { data: allLinks } = await adminClient
        .from('project_item_links')
        .select(`
          item_id,
          sequence,
          items!inner(id, name, status)
        `)
        .eq('project_id', projectId)
        .eq('items.status', 'Active')
        .order('sequence', { ascending: true });

      if (!allLinks || allLinks.length === 0) {
        return { itemName: 'No Active Items', projectName: projectName, projectId };
      }

      const itemIndex = placeholderIndex - 1;

      if (itemIndex >= 0 && itemIndex < allLinks.length) {
        const item = (allLinks[itemIndex].items as any);
        return { itemName: item.name, projectName: projectName, projectId };
      }

      if (allLinks.length > 0) {
        const item = (allLinks[0].items as any);
        return { itemName: item.name, projectName: projectName, projectId };
      }

      return { itemName: 'No Active Items', projectName: projectName, projectId };
    }

    return { itemName: 'No Active Items', projectName: null, projectId: null };
  } catch (error) {
    return { itemName: 'Error Loading Item', projectName: null, projectId: null };
  }
}
</file>

<file path="types/database.ts">
export type Profile = {
  id: string;
  username: string | null;
  first_name: string | null;
  last_name: string | null;
  birthdate: string | null;
  gender: 'Male' | 'Female' | 'Other' | null;
  show_master_list: boolean;
  created_at: string;
};

export type List = {
  id: string;
  user_id: string;
  name: string;
  is_default: boolean;
  created_at: string;
};

export type Project = {
  id: string;
  user_id: string;
  list_id: string;
  name: string;
  priority: 1 | 2 | 3 | 4 | 5;
  status: 'Active' | 'Inactive' | 'Completed';
  created_at: string;
  due_date: string | null;
};

export type ItemType = 'Errand' | 'ProjectItem' | 'ScheduledItem' | 'Routine';
export type ItemStatus = 'Active' | 'Inactive' | 'Completed';

export type Item = {
  id: string;
  user_id: string;
  list_id: string;
  name: string;
  project_id: string | null;
  type: ItemType;
  status: ItemStatus;
  date_added: string;
  date_completed: string | null;
  scheduled_start_time: string | null;
  scheduled_end_time: string | null;
};

export type ProjectItemLink = {
  id: string;
  project_id: string;
  item_id: string;
  sequence: number;
};

export type MasterList = {
  id: string;
  user_id: string;
  list_id: string;
  position: number;
  item_id: string | null;
  project_placeholder_id: string | null;
};
</file>

<file path="types/index.ts">
export * from './database';
</file>

<file path=".eslintrc.json">
{
  "extends": "next/core-web-vitals"
}
</file>

<file path=".gitignore">
node_modules
.next
out
.DS_Store
*.pem
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*
.env*.local
.vercel
*.tsbuildinfo
next-env.d.ts

.env
.idea
</file>

<file path=".repomixignore">
# Node modules
node_modules
package-lock.json
pnpm-lock.yaml
yarn.lock

# Next.js
.next
out
build
dist

# System files
.DS_Store
Thumbs.db

# IDEs
.idea
.vscode

# Git
.git

# Environment variables (security)
.env
.env.local
.env.*

# Repomix output
repomix-output.xml
repomix-output.json
repomix-output.txt

# Generated types
next-env.d.ts
</file>

<file path="DATABASE_SCHEMA.sql">
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  username TEXT UNIQUE,
  first_name TEXT,
  last_name TEXT,
  birthdate DATE,
  gender TEXT CHECK (gender IN ('Male', 'Female', 'Other')),
  show_master_list BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE lists (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  is_default BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE projects (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  list_id UUID REFERENCES lists(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  priority INTEGER CHECK (priority >= 1 AND priority <= 5) NOT NULL,
  status TEXT CHECK (status IN ('Active', 'Inactive', 'Completed')) DEFAULT 'Active',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  due_date TIMESTAMP WITH TIME ZONE
);

CREATE TABLE items (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  list_id UUID REFERENCES lists(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  type TEXT CHECK (type IN ('Errand', 'ProjectItem', 'ScheduledItem', 'Routine')) DEFAULT 'Errand',
  status TEXT CHECK (status IN ('Active', 'Inactive', 'Completed')) DEFAULT 'Active',
  date_added TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  date_completed TIMESTAMP WITH TIME ZONE,
  scheduled_start_time TIMESTAMP WITH TIME ZONE,
  scheduled_end_time TIMESTAMP WITH TIME ZONE
);

CREATE TABLE project_item_links (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE NOT NULL,
  item_id UUID REFERENCES items(id) ON DELETE CASCADE NOT NULL,
  sequence INTEGER NOT NULL,
  UNIQUE(project_id, item_id),
  UNIQUE(project_id, sequence)
);

CREATE TABLE master_list (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  list_id UUID REFERENCES lists(id) ON DELETE CASCADE NOT NULL,
  position INTEGER NOT NULL,
  item_id UUID REFERENCES items(id) ON DELETE CASCADE,
  project_placeholder_id TEXT,
  UNIQUE(user_id, list_id, position),
  CHECK ((item_id IS NOT NULL AND project_placeholder_id IS NULL) OR 
         (item_id IS NULL AND project_placeholder_id IS NOT NULL))
);

CREATE INDEX idx_lists_user_id ON lists(user_id);
CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_projects_list_id ON projects(list_id);
CREATE INDEX idx_items_user_id ON items(user_id);
CREATE INDEX idx_items_list_id ON items(list_id);
CREATE INDEX idx_items_project_id ON items(project_id);
CREATE INDEX idx_project_item_links_project ON project_item_links(project_id);
CREATE INDEX idx_master_list_user_position ON master_list(user_id, list_id, position);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE lists ENABLE ROW LEVEL SECURITY;
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE items ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_item_links ENABLE ROW LEVEL SECURITY;
ALTER TABLE master_list ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile" ON profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can view own lists" ON lists FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own lists" ON lists FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own lists" ON lists FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own lists" ON lists FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own projects" ON projects FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own projects" ON projects FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own projects" ON projects FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own projects" ON projects FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own items" ON items FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own items" ON items FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own items" ON items FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own items" ON items FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own project_item_links" ON project_item_links FOR SELECT USING (
  EXISTS (SELECT 1 FROM projects WHERE projects.id = project_item_links.project_id AND projects.user_id = auth.uid())
);
CREATE POLICY "Users can insert own project_item_links" ON project_item_links FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM projects WHERE projects.id = project_item_links.project_id AND projects.user_id = auth.uid())
);
CREATE POLICY "Users can update own project_item_links" ON project_item_links FOR UPDATE USING (
  EXISTS (SELECT 1 FROM projects WHERE projects.id = project_item_links.project_id AND projects.user_id = auth.uid())
);
CREATE POLICY "Users can delete own project_item_links" ON project_item_links FOR DELETE USING (
  EXISTS (SELECT 1 FROM projects WHERE projects.id = project_item_links.project_id AND projects.user_id = auth.uid())
);

CREATE POLICY "Users can view own master_list" ON master_list FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own master_list" ON master_list FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own master_list" ON master_list FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own master_list" ON master_list FOR DELETE USING (auth.uid() = user_id);
</file>

<file path="middleware.ts">
import { type NextRequest } from 'next/server';
import { updateSession } from '@/lib/supabase/middleware';

export async function middleware(request: NextRequest) {
  const response = await updateSession(request);
  response.headers.set('x-pathname', request.nextUrl.pathname);
  return response;
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {}

module.exports = nextConfig
</file>

<file path="README.md">
# Elephant App

A task and project management application built with Next.js 15, Supabase, and TypeScript.

## Overview

Elephant App is a productivity tool that helps you manage tasks and projects using a master list system. It implements the "Elephant in the Room" methodology where you always work on the most important task first.

## Features

- **Project Management**: Create and manage projects with priorities
- **Task Management**: Add errands and project items
- **Master List**: Automatic prioritization of tasks
- **Do Now Page**: Focus on one task at a time
- **Take a Bite**: Break down large tasks into smaller pieces
- **Completion Tracking**: View all completed tasks and projects
- **Import/Export**: Backup and restore your data
- **Responsive Design**: Works on desktop and mobile devices

## Tech Stack

- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript
- **Database**: Supabase (PostgreSQL)
- **Authentication**: Supabase Auth
- **Styling**: CSS Modules
- **Deployment**: Vercel

## Prerequisites

- Node.js 18+ and npm
- Supabase account
- Git

## Setup Instructions

### 1. Clone the Repository

```bash
git clone <repository-url>
cd elephant-app
```

### 2. Install Dependencies

```bash
npm install
```

### 3. Environment Variables

Create a `.env.local` file in the root directory:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

**Note:** 
- For local development, set `NEXT_PUBLIC_SITE_URL=http://localhost:3000`
- For production, set it to your actual domain (e.g., `https://yourdomain.com`)
- You can copy `.env.local.example` to `.env.local` and update the values

### 4. Supabase Email Configuration

For password reset to work properly, you need to configure the email template in Supabase:

1. Go to your Supabase Dashboard
2. Navigate to **Authentication** ‚Üí **Email Templates**
3. Find **"Reset Password"** template
4. Make sure the redirect URL uses this format: `{{ .SiteURL }}/auth/callback?code={{ .TokenHash }}&type=recovery&next=/auth/reset-password`
5. Or use the default template which should work automatically

### 5. Database Setup

Run the following SQL in your Supabase SQL Editor:

```sql
-- Create profiles table
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT,
  first_name TEXT,
  last_name TEXT,
  birthdate DATE,
  gender TEXT,
  show_master_list BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create projects table
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  priority INTEGER NOT NULL DEFAULT 3,
  status TEXT NOT NULL DEFAULT 'Active',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  due_date TIMESTAMP WITH TIME ZONE
);

-- Create items table
CREATE TABLE items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  type TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'Active',
  date_added TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  date_completed TIMESTAMP WITH TIME ZONE
);

-- Create master_list table
CREATE TABLE master_list (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  position INTEGER NOT NULL,
  item_id UUID REFERENCES items(id) ON DELETE CASCADE,
  project_placeholder_id TEXT,
  UNIQUE(user_id, position)
);

-- Create project_item_links table
CREATE TABLE project_item_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES items(id) ON DELETE CASCADE,
  sequence INTEGER NOT NULL,
  UNIQUE(project_id, item_id)
);

-- Enable Row Level Security
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE items ENABLE ROW LEVEL SECURITY;
ALTER TABLE master_list ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_item_links ENABLE ROW LEVEL SECURITY;

-- Create RLS Policies
CREATE POLICY "Users can view own profile" ON profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Users can insert own profile" ON profiles FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can view own projects" ON projects FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own projects" ON projects FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own projects" ON projects FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own projects" ON projects FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own items" ON items FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own items" ON items FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own items" ON items FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own items" ON items FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own master list" ON master_list FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own master list" ON master_list FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own master list" ON master_list FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own master list" ON master_list FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view project item links" ON project_item_links FOR SELECT USING (
  EXISTS (SELECT 1 FROM projects WHERE projects.id = project_item_links.project_id AND projects.user_id = auth.uid())
);
CREATE POLICY "Users can insert project item links" ON project_item_links FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM projects WHERE projects.id = project_item_links.project_id AND projects.user_id = auth.uid())
);
CREATE POLICY "Users can update project item links" ON project_item_links FOR UPDATE USING (
  EXISTS (SELECT 1 FROM projects WHERE projects.id = project_item_links.project_id AND projects.user_id = auth.uid())
);
CREATE POLICY "Users can delete project item links" ON project_item_links FOR DELETE USING (
  EXISTS (SELECT 1 FROM projects WHERE projects.id = project_item_links.project_id AND projects.user_id = auth.uid())
);
```

### 6. Run Development Server

```bash
npm run dev
```

Open [http://localhost:3000](http://localhost:3000) in your browser.

## Deployment

### Deploy to Vercel

1. Push your code to GitHub
2. Import project in Vercel
3. Add environment variables in Vercel dashboard
4. Deploy

## Usage

### Getting Started

1. **Sign Up**: Create an account at `/auth/signup`
2. **Add Items**: Go to Dashboard and add your first task
3. **Create Projects**: Organize related tasks into projects
4. **Do Now**: Navigate to "Do Now" to work on your top priority
5. **Complete Tasks**: Mark tasks as completed when done
6. **View Progress**: Check completed items in the Completed page

### Master List

The Master List automatically prioritizes your tasks based on:
- Project priorities (1-5, where 1 is highest)
- Project item sequence
- Errand order

### Take a Bite

When a task is too large, use "Take a Bite" to:
1. Split the current task into two smaller tasks
2. Work on the first part immediately
3. Keep the second part in the queue

## Known Limitations

- Master List is a testing feature (enable in Settings)
- Import/Export uses JSON format only
- Maximum 1200px container width on desktop

## Project Structure

```
elephant-app/
‚îú‚îÄ‚îÄ app/                    # Next.js app directory
‚îÇ   ‚îú‚îÄ‚îÄ auth/              # Authentication pages
‚îÇ   ‚îú‚îÄ‚îÄ completed/         # Completed items page
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/         # Dashboard page
‚îÇ   ‚îú‚îÄ‚îÄ do-now/            # Do Now page
‚îÇ   ‚îú‚îÄ‚îÄ master-list/       # Master List page
‚îÇ   ‚îú‚îÄ‚îÄ projects/          # Projects pages
‚îÇ   ‚îú‚îÄ‚îÄ settings/          # Settings page
‚îÇ   ‚îú‚îÄ‚îÄ components/        # React components
‚îÇ   ‚îî‚îÄ‚îÄ globals.css        # Global styles
‚îú‚îÄ‚îÄ lib/                   # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ actions/           # Server actions
‚îÇ   ‚îú‚îÄ‚îÄ supabase/          # Supabase clients
‚îÇ   ‚îî‚îÄ‚îÄ utils/             # Helper functions
‚îú‚îÄ‚îÄ components/            # Shared components
‚îî‚îÄ‚îÄ middleware.ts          # Next.js middleware
```

## License

MIT

## Support

For issues and questions, please open an issue on GitHub.
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="components/ProjectDetailClient.tsx">
'use client';

import { useTransition, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import {
  updateProjectName,
  updateProjectPriority,
  updateItemSequence,
  deleteProjectItem,
  updateItemName,
} from '@/lib/actions/projects';

interface ProjectDetailClientProps {
  projectId: string;
  project: any;
  projectItems: any[];
  editItemId?: string;
  onAddItem: (formData: FormData) => void;
}

export default function ProjectDetailClient({
  projectId,
  project,
  projectItems,
  editItemId,
  onAddItem,
}: ProjectDetailClientProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [isAddingItems, startAddTransition] = useTransition();
  const [optimisticItems, setOptimisticItems] = useState(projectItems);
  const [itemInputs, setItemInputs] = useState([{ id: 1, value: '' }]);
  const [bulkText, setBulkText] = useState('');

  const handleUpdateName = async (formData: FormData) => {
    const name = formData.get('name') as string;
    if (name) {
      startTransition(async () => {
        await updateProjectName(projectId, name);
        router.refresh();
      });
    }
  };

  const handleUpdatePriority = async (formData: FormData) => {
    const priority = parseInt(formData.get('priority') as string);
    startTransition(async () => {
      await updateProjectPriority(projectId, priority);
      router.refresh();
    });
  };


  const handleMoveUp = async (itemId: string, index: number) => {
    const newItems = [...optimisticItems];
    [newItems[index - 1], newItems[index]] = [newItems[index], newItems[index - 1]];
    setOptimisticItems(newItems);

    startTransition(async () => {
      await updateItemSequence(projectId, itemId, 'up');
      router.refresh();
    });
  };

  const handleMoveDown = async (itemId: string, index: number) => {
    const newItems = [...optimisticItems];
    [newItems[index], newItems[index + 1]] = [newItems[index + 1], newItems[index]];
    setOptimisticItems(newItems);

    startTransition(async () => {
      await updateItemSequence(projectId, itemId, 'down');
      router.refresh();
    });
  };

  const handleDeleteItem = async (itemId: string) => {
    setOptimisticItems(optimisticItems.filter((link: any) => link.items.id !== itemId));

    startTransition(async () => {
      await deleteProjectItem(itemId);
      router.refresh();
    });
  };

  const handleUpdateItemName = async (itemId: string, formData: FormData) => {
    const name = formData.get('name') as string;
    if (name) {
      startTransition(async () => {
        await updateItemName(itemId, name);
        router.push(`/projects/${projectId}`);
      });
    }
  };

  const addItemInput = () => {
    if (itemInputs.length < 10) {
      setItemInputs([...itemInputs, { id: Date.now(), value: '' }]);
    }
  };

  const removeItemInput = (id: number) => {
    if (itemInputs.length > 1) {
      setItemInputs(itemInputs.filter(input => input.id !== id));
    }
  };

  const handleInputChange = (id: number, value: string) => {
    setItemInputs(itemInputs.map(input =>
      input.id === id ? { ...input, value } : input
    ));
  };

  const handleAddItems = async (formData: FormData) => {
    startAddTransition(async () => {
      await onAddItem(formData);
    });
  };

  const handleBulkPaste = () => {
    const lines = bulkText
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0);

    if (lines.length === 0) return;

    const newInputs = lines.slice(0, 50).map((line, index) => ({
      id: Date.now() + index,
      value: line
    }));

    setItemInputs(newInputs);
    setBulkText('');
  };

  return (
    <div className="page-container">
      <div className="page-header">
        <Link href="/projects">
          <button type="button" className="btn-back">‚Üê Back to Projects</button>
        </Link>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '1rem', marginTop: '1rem' }}>
          <div>
            <h1 className="page-title" style={{ margin: 0 }}>Edit Project</h1>
            <p className="page-subtitle" style={{ margin: 0 }}>{project.name}</p>
          </div>
          <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', backgroundColor: '#f8f9fa', padding: '0.75rem', borderRadius: '8px', border: '1px solid #dee2e6' }}>
            <form action={handleUpdateName} style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', margin: 0, padding: 0, boxShadow: 'none', background: 'transparent' }}>
              <input
                id="name"
                name="name"
                type="text"
                defaultValue={project.name}
                required
                placeholder="Name"
                disabled={isPending}
                style={{ padding: '0.4rem 0.6rem', fontSize: '0.9rem', width: '200px' }}
              />
              <button type="submit" className="btn-primary" disabled={isPending} style={{ padding: '0.4rem 0.6rem', fontSize: '0.85rem' }}>
                {isPending ? '...' : 'Save'}
              </button>
            </form>
            <div style={{ width: '1px', height: '24px', backgroundColor: '#dee2e6' }}></div>
            <form action={handleUpdatePriority} style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', margin: 0, padding: 0, boxShadow: 'none', background: 'transparent' }}>
              <label htmlFor="priority" style={{ fontSize: '0.85rem', fontWeight: '600', whiteSpace: 'nowrap' }}>Priority:</label>
              <select
                id="priority"
                name="priority"
                defaultValue={project.priority.toString()}
                disabled={isPending}
                onChange={(e) => {
                  const formData = new FormData();
                  formData.append('priority', e.target.value);
                  handleUpdatePriority(formData);
                }}
                style={{ padding: '0.4rem 0.4rem', fontSize: '0.9rem', width: 'auto' }}
              >
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </form>
          </div>
        </div>
      </div>



      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Add Items To Project</h2>
        </div>

        <div style={{ marginBottom: '1.5rem', padding: '1rem', backgroundColor: '#f8f9fa', borderRadius: '8px', border: '1px solid #dee2e6' }}>
          <h3 style={{ fontSize: '1rem', marginBottom: '0.75rem', fontWeight: '600' }}>
            Bulk Add (Paste from Excel)
          </h3>
          <p style={{ fontSize: '0.875rem', color: '#6c757d', marginBottom: '0.75rem' }}>
            Paste a list of items (one per line). Works great with copy-paste from Excel or any text editor.
          </p>
          <textarea
            value={bulkText}
            onChange={(e) => setBulkText(e.target.value)}
            placeholder="Paste your list here (one item per line)&#10;Example:&#10;Write script for video&#10;Plan out video scenes&#10;shoot video scene 1"
            disabled={isAddingItems}
            style={{
              width: '100%',
              minHeight: '120px',
              padding: '0.75rem',
              fontSize: '0.95rem',
              border: '1px solid #ced4da',
              borderRadius: '6px',
              fontFamily: 'inherit',
              resize: 'vertical',
              marginBottom: '0.75rem'
            }}
          />
          <button
            type="button"
            onClick={handleBulkPaste}
            disabled={isAddingItems || !bulkText.trim()}
            className="btn-primary"
            style={{ padding: '0.5rem 1rem', fontSize: '0.9rem' }}
          >
            Load Items from List
          </button>
        </div>

        <div style={{ marginBottom: '1rem', padding: '0.75rem', backgroundColor: '#e7f3ff', borderRadius: '6px', border: '1px solid #b3d9ff' }}>
          <p style={{ fontSize: '0.875rem', margin: 0, color: '#004085' }}>
            <strong>Or add items individually below:</strong>
          </p>
        </div>

        <form id="add-item-form" action={handleAddItems}>
          {itemInputs.map((input, index) => (
            <div key={input.id} className="form-group" style={{ display: 'flex', gap: '0.5rem', alignItems: 'flex-end' }}>
              <div style={{ flex: 1 }}>
                <label htmlFor={`item_name_${input.id}`}>
                  Item {index + 1} Name
                </label>
                <input
                  id={`item_name_${input.id}`}
                  name={`name_${index}`}
                  type="text"
                  value={input.value}
                  onChange={(e) => handleInputChange(input.id, e.target.value)}
                  placeholder="Enter item name"
                  disabled={isAddingItems}
                />
              </div>
              {itemInputs.length > 1 && (
                <button
                  type="button"
                  onClick={() => removeItemInput(input.id)}
                  className="btn-danger"
                  style={{ marginBottom: '0.5rem', padding: '0.4rem 0.8rem', fontSize: '0.85rem' }}
                  disabled={isAddingItems}
                >
                  Remove
                </button>
              )}
            </div>
          ))}
          <div className="form-actions" style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
            {itemInputs.length < 50 && (
              <button
                type="button"
                onClick={addItemInput}
                className="btn-secondary"
                style={{ padding: '0.5rem 1rem', fontSize: '0.9rem' }}
                disabled={isAddingItems}
              >
                + Add Another Item
              </button>
            )}
            {itemInputs.length > 1 && itemInputs.some(input => input.value.trim() !== '') && (
              <button
                type="button"
                onClick={() => setItemInputs([{ id: Date.now(), value: '' }])}
                className="btn-secondary"
                style={{ padding: '0.5rem 1rem', fontSize: '0.9rem' }}
                disabled={isAddingItems}
              >
                Clear All
              </button>
            )}
            <button
              type="submit"
              className="btn-primary"
              style={{ padding: '0.5rem 1rem', fontSize: '0.9rem', cursor: isAddingItems ? 'wait' : 'pointer' }}
              disabled={isAddingItems}
            >
              {isAddingItems ? 'Adding...' : `Add ${itemInputs.length} Item${itemInputs.length > 1 ? 's' : ''}`}
            </button>
          </div>
        </form>
      </section>

      <section className="section">
        <div className="section-header">
          <h2 className="section-title">Project Items</h2>
        </div>
        {!optimisticItems || optimisticItems.length === 0 ? (
          <div className="table-empty">
            <p>No items in this project.</p>
          </div>
        ) : (
          <div className="table-container">
            <table className="data-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Item Name</th>
                  <th>Status</th>
                  <th className="actions-column">Actions</th>
                </tr>
              </thead>
              <tbody>
                {optimisticItems.map((link: any, index: number) => {
                  const item = link.items;
                  const isEditing = editItemId === item.id;

                  return (
                    <tr key={link.id}>
                      <td>{index + 1}</td>
                      <td>
                        {isEditing ? (
                          <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                            <form action={handleUpdateItemName.bind(null, item.id)} style={{ display: 'flex', gap: '0.5rem', flex: 1, margin: 0, padding: 0, boxShadow: 'none', background: 'transparent' }}>
                              <input
                                name="name"
                                type="text"
                                defaultValue={item.name}
                                required
                                style={{ flex: 1, minWidth: '200px' }}
                                disabled={isPending}
                              />
                              <button type="submit" className="btn-success" disabled={isPending} style={{ padding: '0.35rem 0.65rem', fontSize: '0.8rem' }}>
                                {isPending ? 'Saving...' : 'Save'}
                              </button>
                            </form>
                            <Link href={`/projects/${projectId}`}>
                              <button type="button" className="btn-secondary" style={{ padding: '0.35rem 0.65rem', fontSize: '0.8rem' }}>Cancel</button>
                            </Link>
                          </div>
                        ) : (
                          item.name
                        )}
                      </td>
                      <td>
                        <span style={{
                          fontSize: '0.85rem',
                          color: item.status === 'Active' ? '#28a745' : item.status === 'Completed' ? '#007bff' : '#6c757d',
                          fontWeight: 'bold'
                        }}>
                          {item.status}
                        </span>
                      </td>
                      <td className="actions-column">
                        {!isEditing && (
                          <>
                            <Link href={`/projects/${projectId}?editItem=${item.id}`}>
                              <button type="button" className="btn-warning">Edit</button>
                            </Link>
                            {index > 0 && (
                              <button
                                type="button"
                                onClick={() => handleMoveUp(item.id, index)}
                                className="btn-secondary"
                                disabled={isPending}
                              >
                                ‚Üë
                              </button>
                            )}
                            {index < optimisticItems.length - 1 && (
                              <button
                                type="button"
                                onClick={() => handleMoveDown(item.id, index)}
                                className="btn-secondary"
                                disabled={isPending}
                              >
                                ‚Üì
                              </button>
                            )}
                            <button
                              type="button"
                              onClick={() => handleDeleteItem(item.id)}
                              className="btn-danger"
                              disabled={isPending}
                            >
                              Delete
                            </button>
                          </>
                        )}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="lib/actions/completed.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';

export async function getCompletedErrands(userId: string, dateFilter?: string) {
  try {
    const adminClient = createAdminClient();

    let query = adminClient
      .from('items')
      .select('*')
      .eq('user_id', userId)
      .eq('status', 'Completed')
      .is('project_id', null)
      .order('date_completed', { ascending: false });

    if (dateFilter === '7days') {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      query = query.gte('date_completed', sevenDaysAgo.toISOString());
    } else if (dateFilter === '30days') {
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      query = query.gte('date_completed', thirtyDaysAgo.toISOString());
    }

    const { data, error } = await query;

    if (error) {
      return { success: false, error: error.message, data: [] };
    }

    return { success: true, data: data || [] };
  } catch (error) {
    return { success: false, error: error instanceof Error ? error.message : 'Failed to fetch completed errands', data: [] };
  }
}

export async function getCompletedProjects(userId: string) {
  try {
    const adminClient = createAdminClient();

    // optimized: fetch project AND count of items in one go
    // Note: We use 'head: true' logic via count inside select if supported,
    // or we just fetch the relations. Supabase/PostgREST syntax for count is:
    // select('*, items(count)')
    const { data: projects, error: projectsError } = await adminClient
      .from('projects')
      .select('*, items(count)')
      .eq('user_id', userId)
      .eq('status', 'Completed')
      .order('created_at', { ascending: false });

    if (projectsError) {
      return { success: false, error: projectsError.message, data: [] };
    }

    if (!projects || projects.length === 0) {
      return { success: true, data: [] };
    }

    // Map the result to match your frontend expectation
    const projectsWithCounts = projects.map((project: any) => ({
      ...project,
      // Supabase returns [{ count: 5 }] for relations, or just the number depending on version
      // The safest way to handle the count response:
      itemCount: project.items?.[0]?.count || 0,
    }));

    return { success: true, data: projectsWithCounts };
  } catch (error) {
    return { success: false, error: error instanceof Error ? error.message : 'Failed to fetch completed projects', data: [] };
  }
}

export async function getCompletedProjectItems(userId: string, projectId?: string, dateFilter?: string) {
  try {
    const adminClient = createAdminClient();

    // optimized: Fetch items and join with their parent project name immediately
    let itemsQuery = adminClient
      .from('items')
      .select(`
        *, 
        project_item_links(sequence),
        projects(name)
      `)
      .eq('user_id', userId)
      .eq('status', 'Completed')
      .not('project_id', 'is', null);

    if (projectId) {
      itemsQuery = itemsQuery.eq('project_id', projectId);
    }

    if (dateFilter === '7days') {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      itemsQuery = itemsQuery.gte('date_completed', sevenDaysAgo.toISOString());
    } else if (dateFilter === '30days') {
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      itemsQuery = itemsQuery.gte('date_completed', thirtyDaysAgo.toISOString());
    }

    const { data: items, error: itemsError } = await itemsQuery;

    if (itemsError) {
      return { success: false, error: itemsError.message, data: [] };
    }

    if (!items || items.length === 0) {
      return { success: true, data: [] };
    }

    // The grouping logic remains similar but relies on the data we just fetched
    const groupedItems = items.reduce((acc: any, item: any) => {
      const pId = item.project_id;
      // Access the joined project name directly
      const pName = item.projects?.name || 'Unknown Project';

      if (!acc[pId]) {
        acc[pId] = {
          projectId: pId,
          projectName: pName,
          items: [],
        };
      }
      acc[pId].items.push({
        id: item.id,
        name: item.name,
        dateCompleted: item.date_completed,
        sequence: item.project_item_links?.[0]?.sequence || 0,
      });
      return acc;
    }, {});

    Object.values(groupedItems).forEach((group: any) => {
      group.items.sort((a: any, b: any) => a.sequence - b.sequence);
    });

    const result = Object.values(groupedItems).sort((a: any, b: any) => {
      const aLatest = Math.max(...a.items.map((i: any) => new Date(i.dateCompleted).getTime()));
      const bLatest = Math.max(...b.items.map((i: any) => new Date(i.dateCompleted).getTime()));
      return bLatest - aLatest;
    });

    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: error instanceof Error ? error.message : 'Failed to fetch completed project items', data: [] };
  }
}
</file>

<file path="lib/actions/items.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { revalidatePath } from 'next/cache';
import { reindexMasterList } from '@/lib/utils/masterlist';
import { reprocessList } from '@/lib/actions/reprocess';
import { getActiveListId } from '@/lib/utils/list-context';
import type { Item, ItemType, ItemStatus } from '@/types';

export async function createItem(formData: FormData) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  const data = {
    user_id: user.id,
    name: formData.get('name') as string,
    project_id: formData.get('project_id') as string || null,
    type: (formData.get('type') as ItemType) || 'Errand',
    status: (formData.get('status') as ItemStatus) || 'Active',
    scheduled_start_time: formData.get('scheduled_start_time') as string || null,
    scheduled_end_time: formData.get('scheduled_end_time') as string || null,
  };

  await supabase.from('items').insert(data);

  revalidatePath('/do-now');
  revalidatePath('/completed');
  revalidatePath('/master-list');
}

export async function updateItem(id: string, formData: FormData) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  const status = formData.get('status') as ItemStatus;
  const data: Partial<Item> = {
    name: formData.get('name') as string,
    project_id: formData.get('project_id') as string || null,
    type: formData.get('type') as ItemType,
    status,
    scheduled_start_time: formData.get('scheduled_start_time') as string || null,
    scheduled_end_time: formData.get('scheduled_end_time') as string || null,
  };

  if (status === 'Completed') {
    data.date_completed = new Date().toISOString();
  }

  await supabase
    .from('items')
    .update(data)
    .eq('id', id)
    .eq('user_id', user.id);

  revalidatePath('/do-now');
  revalidatePath('/completed');
  revalidatePath('/master-list');
}

export async function deleteItem(id: string) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  await supabase
    .from('items')
    .delete()
    .eq('id', id)
    .eq('user_id', user.id);

  revalidatePath('/do-now');
  revalidatePath('/completed');
  revalidatePath('/master-list');
}

export async function getItems(status?: ItemStatus) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: [], error: 'Unauthorized' };
  }

  let query = supabase
    .from('items')
    .select('*')
    .eq('user_id', user.id);

  if (status) {
    query = query.eq('status', status);
  }

  const { data, error } = await query.order('date_added', { ascending: false });

  if (error) {
    return { data: [], error: error.message };
  }

  return { data: data as Item[], error: null };
}

export async function getItemsByType(type: ItemType) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: [], error: 'Unauthorized' };
  }

  const { data, error } = await supabase
    .from('items')
    .select('*')
    .eq('user_id', user.id)
    .eq('type', type)
    .order('date_added', { ascending: false });

  if (error) {
    return { data: [], error: error.message };
  }

  return { data: data as Item[], error: null };
}

export async function createNewItem(name: string, projectId?: string | null) {
  try {
    const supabase = await createClient();
    const adminClient = createAdminClient();

    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user) {
      return { success: false, error: 'Unauthorized' };
    }

    if (!name || name.trim() === '') {
      return { success: false, error: 'Item name is required' };
    }

    const listId = await getActiveListId();

    if (!projectId) {
      const { data: newItem, error: itemError } = await adminClient
        .from('items')
        .insert({
          user_id: user.id,
          list_id: listId,
          name: name.trim(),
          type: 'Errand',
          status: 'Active',
          project_id: null,
        })
        .select('id')
        .single();

      if (itemError) {
        return { success: false, error: `Failed to create item: ${itemError.message}` };
      }

      const { data: maxPosition } = await adminClient
        .from('master_list')
        .select('position')
        .eq('user_id', user.id)
        .eq('list_id', listId)
        .order('position', { ascending: false })
        .limit(1)
        .single();

      const nextPosition = (maxPosition?.position || 0) + 1;

      const { error: masterListError } = await adminClient
        .from('master_list')
        .insert({
          user_id: user.id,
          list_id: listId,
          position: nextPosition,
          item_id: newItem.id,
          project_placeholder_id: null,
        });

      if (masterListError) {
        return { success: false, error: `Failed to add to master list: ${masterListError.message}` };
      }

      await reprocessList(user.id);


      revalidatePath('/dashboard');
      revalidatePath('/master-list');
      revalidatePath('/do-now');

      return { success: true, itemId: newItem.id };
    } else {
      const { data: project } = await adminClient
        .from('projects')
        .select('id')
        .eq('id', projectId)
        .eq('user_id', user.id)
        .single();

      if (!project) {
        return { success: false, error: 'Project not found' };
      }

      const { data: newItem, error: itemError } = await adminClient
        .from('items')
        .insert({
          user_id: user.id,
          list_id: listId,
          name: name.trim(),
          type: 'ProjectItem',
          status: 'Inactive',
          project_id: projectId,
        })
        .select('id')
        .single();

      if (itemError) {
        return { success: false, error: `Failed to create item: ${itemError.message}` };
      }

      const { data: maxSequence } = await adminClient
        .from('project_item_links')
        .select('sequence')
        .eq('project_id', projectId)
        .order('sequence', { ascending: false })
        .limit(1)
        .single();

      const nextSequence = (maxSequence?.sequence || 0) + 1;

      const { error: linkError } = await adminClient
        .from('project_item_links')
        .insert({
          project_id: projectId,
          item_id: newItem.id,
          sequence: nextSequence,
        });

      if (linkError) {
        return { success: false, error: `Failed to link item to project: ${linkError.message}` };
      }

      await reprocessList(user.id);

      revalidatePath('/dashboard');
      revalidatePath('/projects');
      revalidatePath(`/projects/${projectId}`);
      revalidatePath('/master-list');
      revalidatePath('/do-now');

      return { success: true, itemId: newItem.id };
    }
  } catch (error) {
    return { success: false, error: error instanceof Error ? error.message : 'Unknown error occurred' };
  }
}

export async function completeItem(masterListPosition: number = 1) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const { data: masterListEntry, error: fetchError } = await adminClient
    .from('master_list')
    .select('*')
    .eq('user_id', user.id)
    .eq('position', masterListPosition)
    .single();

  if (fetchError || !masterListEntry) {
    throw new Error('Master list entry not found');
  }

  let itemToComplete: string | null = null;

  if (masterListEntry.item_id) {
    itemToComplete = masterListEntry.item_id;
  } else if (masterListEntry.project_placeholder_id) {
    const parts = masterListEntry.project_placeholder_id.split('-');
    const projectId = parts.slice(0, -1).join('-');

    const { data: links, error: linksError } = await adminClient
      .from('project_item_links')
      .select(`
        item_id,
        items (
          id,
          status
        )
      `)
      .eq('project_id', projectId)
      .order('sequence', { ascending: true });

    if (linksError || !links || links.length === 0) {
      throw new Error('No project items found');
    }

    for (const link of links) {
      const item = link.items as any;
      if (item && item.status === 'Active') {
        itemToComplete = item.id;
        break;
      }
    }

    if (!itemToComplete) {
      throw new Error('No active project item found');
    }
  } else {
    throw new Error('Invalid master list entry');
  }

  const { error: updateError } = await adminClient
    .from('items')
    .update({
      status: 'Completed',
      date_completed: new Date().toISOString(),
    })
    .eq('id', itemToComplete);

  if (updateError) {
    throw new Error(updateError.message);
  }

  const { error: deleteError } = await adminClient
    .from('master_list')
    .delete()
    .eq('id', masterListEntry.id);

  if (deleteError) {
    throw new Error(deleteError.message);
  }

  await reindexMasterList(user.id);
  await reprocessList(user.id);

  revalidatePath('/master-list');
  revalidatePath('/do-now');
  revalidatePath('/completed');

  return { success: true };
}

export async function takeABite(masterListPosition: number, newText1: string, newText2: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const { data: masterListEntry, error: fetchError } = await adminClient
    .from('master_list')
    .select('*')
    .eq('user_id', user.id)
    .eq('position', masterListPosition)
    .single();

  if (fetchError || !masterListEntry) {
    throw new Error('Master list entry not found');
  }

  if (masterListEntry.item_id) {
    const { error: updateError } = await adminClient
      .from('items')
      .update({ name: newText1 })
      .eq('id', masterListEntry.item_id);

    if (updateError) {
      throw new Error(updateError.message);
    }

    await createNewItem(newText2, null);
  } else if (masterListEntry.project_placeholder_id) {
    const parts = masterListEntry.project_placeholder_id.split('-');
    const projectId = parts.slice(0, -1).join('-');
    const placeholderIndex = parseInt(parts[parts.length - 1]);

    const { data: activeItems, error: linksError } = await adminClient
      .from('project_item_links')
      .select(`
        item_id,
        sequence,
        items (
          id,
          status
        )
      `)
      .eq('project_id', projectId)
      .order('sequence', { ascending: true });

    if (linksError || !activeItems) {
      throw new Error('Failed to fetch project items');
    }

    const activeItemsList = activeItems.filter((link: any) => {
      const item = link.items as any;
      return item && item.status === 'Active';
    });

    if (activeItemsList.length === 0) {
      throw new Error('No active project items found');
    }

    const currentItem = activeItemsList[placeholderIndex - 1];
    if (!currentItem) {
      throw new Error('Current item not found');
    }

    const currentSequence = currentItem.sequence;
    const currentItemId = (currentItem.items as any).id;

    const { error: updateError } = await adminClient
      .from('items')
      .update({ name: newText1 })
      .eq('id', currentItemId);

    if (updateError) {
      throw new Error(updateError.message);
    }

    const lastActiveItem = activeItemsList[activeItemsList.length - 1];
    const lastActiveItemId = (lastActiveItem.items as any).id;

    const listId = await getActiveListId();

    const { data: newItem, error: itemError } = await adminClient
      .from('items')
      .insert({
        user_id: user.id,
        list_id: listId,
        name: newText2,
        type: 'ProjectItem',
        status: 'Active',
        project_id: projectId,
      })
      .select('id')
      .single();

    if (itemError) {
      throw new Error(itemError.message);
    }

    const { data: subsequentLinks, error: subsequentError } = await adminClient
      .from('project_item_links')
      .select('id, sequence')
      .eq('project_id', projectId)
      .gt('sequence', currentSequence)
      .order('sequence', { ascending: false });

    if (subsequentError) {
      throw new Error(subsequentError.message);
    }

    if (subsequentLinks && subsequentLinks.length > 0) {
      for (const link of subsequentLinks) {
        const { error: shiftError } = await adminClient
          .from('project_item_links')
          .update({ sequence: link.sequence + 1 })
          .eq('id', link.id);

        if (shiftError) {
          throw new Error(shiftError.message);
        }
      }
    }

    const { error: linkError } = await adminClient
      .from('project_item_links')
      .insert({
        project_id: projectId,
        item_id: newItem.id,
        sequence: currentSequence + 1,
      });

    if (linkError) {
      throw new Error(linkError.message);
    }

    const { error: deactivateError } = await adminClient
      .from('items')
      .update({ status: 'Inactive' })
      .eq('id', lastActiveItemId);

    if (deactivateError) {
      throw new Error(deactivateError.message);
    }
  } else {
    throw new Error('Invalid master list entry');
  }

  revalidatePath('/master-list');
  revalidatePath('/do-now');
  revalidatePath('/projects');

  return { success: true };
}

export async function editItem(masterListPosition: number, newName: string) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const { data: masterListEntry, error: fetchError } = await adminClient
    .from('master_list')
    .select('*')
    .eq('user_id', user.id)
    .eq('position', masterListPosition)
    .single();

  if (fetchError || !masterListEntry) {
    throw new Error('Master list entry not found');
  }

  let itemToEdit: string | null = null;

  if (masterListEntry.item_id) {
    itemToEdit = masterListEntry.item_id;
  } else if (masterListEntry.project_placeholder_id) {
    const parts = masterListEntry.project_placeholder_id.split('-');
    const projectId = parts.slice(0, -1).join('-');

    const { data: links, error: linksError } = await adminClient
      .from('project_item_links')
      .select(`
        item_id,
        items (
          id,
          status
        )
      `)
      .eq('project_id', projectId)
      .order('sequence', { ascending: true });

    if (linksError || !links || links.length === 0) {
      throw new Error('No project items found');
    }

    for (const link of links) {
      const item = link.items as any;
      if (item && item.status === 'Active') {
        itemToEdit = item.id;
        break;
      }
    }

    if (!itemToEdit) {
      throw new Error('No active project item found');
    }
  } else {
    throw new Error('Invalid master list entry');
  }

  const { error: updateError } = await adminClient
    .from('items')
    .update({ name: newName })
    .eq('id', itemToEdit);

  if (updateError) {
    throw new Error(updateError.message);
  }

  revalidatePath('/master-list');
  revalidatePath('/do-now');

  return { success: true };
}

export async function deleteMasterListItem(masterListPosition: number) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const { data: masterListEntry, error: fetchError } = await adminClient
    .from('master_list')
    .select('*')
    .eq('user_id', user.id)
    .eq('position', masterListPosition)
    .single();

  if (fetchError || !masterListEntry) {
    throw new Error('Master list entry not found');
  }

  if (masterListEntry.item_id) {
    await adminClient
      .from('items')
      .update({ status: 'Inactive' })
      .eq('id', masterListEntry.item_id);
  }

  const { error: deleteError } = await adminClient
    .from('master_list')
    .delete()
    .eq('id', masterListEntry.id);

  if (deleteError) {
    throw new Error(deleteError.message);
  }

  await reindexMasterList(user.id);
  await reprocessList(user.id);

  revalidatePath('/master-list');
  revalidatePath('/do-now');

  return { success: true };
}

export async function completeItemAndNextFromProject(masterListPosition: number = 1) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Unauthorized');
  }

  const { data: masterListEntry, error: fetchError } = await adminClient
    .from('master_list')
    .select('*')
    .eq('user_id', user.id)
    .eq('position', masterListPosition)
    .single();

  if (fetchError || !masterListEntry) {
    throw new Error('Master list entry not found');
  }

  let itemToComplete: string | null = null;
  let currentProjectId: string | null = null;

  if (masterListEntry.item_id) {
    itemToComplete = masterListEntry.item_id;

    const { data: item } = await adminClient
      .from('items')
      .select('project_id')
      .eq('id', itemToComplete)
      .single();

    currentProjectId = item?.project_id || null;
  } else if (masterListEntry.project_placeholder_id) {
    const parts = masterListEntry.project_placeholder_id.split('-');
    currentProjectId = parts.slice(0, -1).join('-');

    const { data: links } = await adminClient
      .from('project_item_links')
      .select(`
        item_id,
        items (
          id,
          status
        )
      `)
      .eq('project_id', currentProjectId)
      .order('sequence', { ascending: true });

    if (!links || links.length === 0) {
      throw new Error('No project items found');
    }

    for (const link of links) {
      const item = link.items as any;
      if (item && item.status === 'Active') {
        itemToComplete = item.id;
        break;
      }
    }

    if (!itemToComplete) {
      throw new Error('No active project item found');
    }
  } else {
    throw new Error('Invalid master list entry');
  }

  if (!currentProjectId) {
    await completeItem(masterListPosition);
    return { success: true, message: 'Item completed (no project association)' };
  }

  const { error: updateError } = await adminClient
    .from('items')
    .update({
      status: 'Completed',
      date_completed: new Date().toISOString(),
    })
    .eq('id', itemToComplete);

  if (updateError) {
    throw new Error(updateError.message);
  }

  const { data: allProjectLinks } = await adminClient
    .from('project_item_links')
    .select(`
      item_id,
      sequence,
      items (
        id,
        status
      )
    `)
    .eq('project_id', currentProjectId)
    .order('sequence', { ascending: true });

  let nextActiveItemId: string | null = null;
  if (allProjectLinks) {
    for (const link of allProjectLinks) {
      const item = link.items as any;
      if (item && item.status === 'Active') {
        nextActiveItemId = item.id;
        break;
      }
    }
  }

  const { error: deleteError } = await adminClient
    .from('master_list')
    .delete()
    .eq('id', masterListEntry.id);

  if (deleteError) {
    throw new Error(deleteError.message);
  }

  await reindexMasterList(user.id);

  if (nextActiveItemId) {
    const { data: allPlaceholders } = await adminClient
      .from('master_list')
      .select('id, position, project_placeholder_id')
      .eq('user_id', user.id)
      .not('project_placeholder_id', 'is', null);

    const projectPlaceholders = allPlaceholders?.filter(p => {
      if (!p.project_placeholder_id) return false;
      const parts = p.project_placeholder_id.split('-');
      const pid = parts.slice(0, -1).join('-');
      return pid === currentProjectId;
    }) || [];

    for (const placeholder of projectPlaceholders) {
      const parts = placeholder.project_placeholder_id!.split('-');
      const index = parseInt(parts[parts.length - 1]);
      const newIndex = index - 1;

      if (newIndex > 0) {
        const newPlaceholderId = `${currentProjectId}-${newIndex}`;
        await adminClient
          .from('master_list')
          .update({ project_placeholder_id: newPlaceholderId })
          .eq('id', placeholder.id);
      } else {
        await adminClient
          .from('master_list')
          .delete()
          .eq('id', placeholder.id);
      }
    }

    await reindexMasterList(user.id);

    const { data: allEntries } = await adminClient
      .from('master_list')
      .select('id, position')
      .eq('user_id', user.id)
      .order('position', { ascending: true });

    if (allEntries) {
      for (const entry of allEntries) {
        await adminClient
          .from('master_list')
          .update({ position: entry.position + 1 })
          .eq('id', entry.id);
      }
    }

    const newPlaceholderId = `${currentProjectId}-1`;
    await adminClient
      .from('master_list')
      .insert({
        user_id: user.id,
        position: 1,
        item_id: null,
        project_placeholder_id: newPlaceholderId,
      });

    await reindexMasterList(user.id);
  }

  await reprocessList(user.id);

  revalidatePath('/master-list');
  revalidatePath('/do-now');
  revalidatePath('/completed');
  revalidatePath('/projects');

  return { success: true, message: nextActiveItemId ? 'Next item from same project brought forward' : 'No more items in this project' };
}
</file>

<file path="lib/actions/masterlist.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { getActiveListId } from '@/lib/utils/list-context';
import type { MasterList } from '@/types';

export async function getMasterList() {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: [], error: 'Unauthorized' };
  }

  const listId = await getActiveListId();

  const { data, error } = await supabase
    .from('master_list')
    .select(`
      *,
      items (*)
    `)
    .eq('user_id', user.id)
    .eq('list_id', listId)
    .order('position', { ascending: true });

  if (error) {
    return { data: [], error: error.message };
  }

  return { data: data as any[], error: null };
}

export async function addToMasterList(itemId: string, position: number) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  await supabase.from('master_list').insert({
    user_id: user.id,
    item_id: itemId,
    position,
  });

  revalidatePath('/master-list');
}

export async function addProjectPlaceholder(projectPlaceholderId: string, position: number) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  await supabase.from('master_list').insert({
    user_id: user.id,
    project_placeholder_id: projectPlaceholderId,
    position,
  });

  revalidatePath('/master-list');
}

export async function removeFromMasterList(id: string) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  await supabase
    .from('master_list')
    .delete()
    .eq('id', id)
    .eq('user_id', user.id);

  revalidatePath('/master-list');
}

export async function reorderMasterList(items: { id: string; position: number }[]) {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return;
  }

  for (const item of items) {
    await supabase
      .from('master_list')
      .update({ position: item.position })
      .eq('id', item.id)
      .eq('user_id', user.id);
  }

  revalidatePath('/master-list');
}

export async function getFirstMasterListEntry() {
  const supabase = await createClient();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { data: null, error: 'Unauthorized' };
  }

  const listId = await getActiveListId();

  const { data: entry, error: fetchError } = await supabase
    .from('master_list')
    .select('*')
    .eq('user_id', user.id)
    .eq('list_id', listId)
    .order('position', { ascending: true })
    .limit(1)
    .maybeSingle();

  if (fetchError || !entry) {
    return { data: null, error: fetchError?.message || 'No entries found' };
  }

  return { data: entry, error: null };
}
</file>

<file path="lib/supabase/middleware.ts">
import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value));
          supabaseResponse = NextResponse.next({
            request,
          });
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  let user = null;

  try {
    const { data, error } = await supabase.auth.getUser();
    if (!error) {
      user = data.user;
    }
  } catch (error) {
    // Silently handle auth errors - user will be redirected to login
  }

  if (
    !user &&
    !request.nextUrl.pathname.startsWith('/auth/login') &&
    !request.nextUrl.pathname.startsWith('/auth/signup') &&
    !request.nextUrl.pathname.startsWith('/auth/forgot-password') &&
    !request.nextUrl.pathname.startsWith('/auth/update-password') &&
    !request.nextUrl.pathname.startsWith('/auth/callback')
  ) {
    const url = request.nextUrl.clone();
    url.pathname = '/auth/login';
    return NextResponse.redirect(url);
  }

  // If user is logged in and on the homepage or auth pages, redirect to dashboard
  if (user) {
    if (request.nextUrl.pathname === '/' ||
      request.nextUrl.pathname.startsWith('/auth/login') ||
      request.nextUrl.pathname.startsWith('/auth/signup')) {
      const url = request.nextUrl.clone();
      url.pathname = '/dashboard';
      return NextResponse.redirect(url);
    }
  }

  return supabaseResponse;
}
</file>

<file path="package.json">
{
  "name": "elephant-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@supabase/auth-helpers-nextjs": "^0.10.0",
    "@supabase/ssr": "^0.5.2",
    "@supabase/supabase-js": "^2.45.4",
    "next": "^16.0.10",
    "react": "^18.3.1",
    "react-dom": "^18.3.1"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "baseline-browser-mapping": "^2.9.19",
    "eslint": "^8",
    "eslint-config-next": "^15.0.3",
    "typescript": "^5"
  }
}
</file>

<file path="lib/actions/dashboard.ts">
'use server';

import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';
import { mapMasterListItem } from '@/lib/utils/masterlist';

export async function getDashboardStats(userId: string) {
  const supabase = await createClient();

  const { getActiveListId } = await import('@/lib/utils/list-context');
  const listId = await getActiveListId();

  const { data: masterListItems } = await supabase
    .from('master_list')
    .select('*')
    .eq('user_id', userId)
    .eq('list_id', listId);

  const itemsToday = masterListItems?.length || 0;

  const { data: activeProjects } = await supabase
    .from('projects')
    .select('id')
    .eq('user_id', userId)
    .eq('list_id', listId)
    .eq('status', 'Active');

  const activeProjectsCount = activeProjects?.length || 0;

  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

  const { data: completedItems } = await supabase
    .from('items')
    .select('id')
    .eq('user_id', userId)
    .eq('status', 'Completed')
    .gte('date_completed', sevenDaysAgo.toISOString());

  const completedThisWeek = completedItems?.length || 0;

  const currentStreak = await calculateStreak(userId);

  return {
    itemsToday,
    activeProjects: activeProjectsCount,
    completedThisWeek,
    currentStreak,
  };
}

export async function getNextItems(userId: string, limit: number) {
  const adminClient = createAdminClient();

  const { getActiveListId } = await import('@/lib/utils/list-context');
  const listId = await getActiveListId();

  const { data: masterListEntries } = await adminClient
    .from('master_list')
    .select('*')
    .eq('user_id', userId)
    .eq('list_id', listId)
    .order('position', { ascending: true })
    .limit(limit);

  if (!masterListEntries || masterListEntries.length === 0) {
    return [];
  }

  const mappedItems = await Promise.all(
    masterListEntries.map(async (entry) => {
      const { itemName, projectName, projectId } = await mapMasterListItem(entry);
      return {
        id: entry.id,
        position: entry.position,
        itemName,
        projectName,
        projectId,
        itemId: entry.item_id,
        projectPlaceholderId: entry.project_placeholder_id,
      };
    })
  );

  return mappedItems;
}

export async function getActiveProjectsOverview(userId: string) {
  const supabase = await createClient();

  const { getActiveListId } = await import('@/lib/utils/list-context');
  const listId = await getActiveListId();

  // optimized: Fetch projects and ALL their linked items/statuses in one single query
  const { data: projects } = await supabase
    .from('projects')
    .select(`
      *,
      project_item_links (
        items (
          status
        )
      )
    `)
    .eq('user_id', userId)
    .eq('list_id', listId)
    .eq('status', 'Active')
    .order('priority', { ascending: false });

  if (!projects || projects.length === 0) {
    return [];
  }

  // Calculate stats in memory (much faster than DB roundtrips)
  const projectsWithProgress = projects.map((project: any) => {
    // Flatten the structure: project -> links -> items
    const allLinks = project.project_item_links || [];

    const totalItems = allLinks.length;
    let completedItems = 0;
    let activeItems = 0;

    allLinks.forEach((link: any) => {
      const status = link.items?.status;
      if (status === 'Completed') completedItems++;
      if (status === 'Active') activeItems++;
    });

    const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;

    return {
      id: project.id,
      name: project.name,
      priority: project.priority,
      totalItems,
      completedItems,
      activeItems,
      progress,
    };
  });

  return projectsWithProgress;
}

export async function getRecentActivity(userId: string, limit: number) {
  const supabase = await createClient();

  const { data: completedItems } = await supabase
    .from('items')
    .select('id, name, date_completed, project_id, projects(name)')
    .eq('user_id', userId)
    .eq('status', 'Completed')
    .not('date_completed', 'is', null)
    .order('date_completed', { ascending: false })
    .limit(limit);

  if (!completedItems || completedItems.length === 0) {
    return [];
  }

  return completedItems.map((item) => ({
    id: item.id,
    name: item.name,
    dateCompleted: item.date_completed,
    projectName: item.project_id && item.projects ? (item.projects as any).name : null,
  }));
}

export async function calculateStreak(userId: string) {
  const supabase = await createClient();

  const { data: completedItems } = await supabase
    .from('items')
    .select('date_completed')
    .eq('user_id', userId)
    .eq('status', 'Completed')
    .not('date_completed', 'is', null)
    .order('date_completed', { ascending: false });

  if (!completedItems || completedItems.length === 0) {
    return 0;
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const dateSet = new Set<string>();
  completedItems.forEach((item) => {
    const date = new Date(item.date_completed!);
    date.setHours(0, 0, 0, 0);
    dateSet.add(date.toISOString().split('T')[0]);
  });

  const sortedDates = Array.from(dateSet).sort().reverse();

  let streak = 0;
  let currentDate = new Date(today);

  for (const dateStr of sortedDates) {
    const itemDate = new Date(dateStr);
    const diffDays = Math.floor((currentDate.getTime() - itemDate.getTime()) / (1000 * 60 * 60 * 24));

    if (diffDays === 0 || diffDays === 1) {
      streak++;
      currentDate = new Date(itemDate);
    } else if (streak > 0) {
      break;
    } else {
      break;
    }
  }

  return streak;
}
</file>

<file path="lib/actions/reprocess.ts">
'use server';

import { createAdminClient } from '@/lib/supabase/admin';
import { getTNML, getPLPI, getNextInactiveProjectItem } from '@/lib/utils/masterlist';
import { getActiveListId } from '@/lib/utils/list-context';

export async function reprocessList(userId: string): Promise<void> {
  const adminClient = createAdminClient();
  const listId = await getActiveListId();

  const { data: projects } = await adminClient
    .from('projects')
    .select('*')
    .eq('user_id', userId)
    .eq('list_id', listId)
    .eq('status', 'Active');

  if (!projects || projects.length === 0) {
    return;
  }

  let itemsAdded = true;
  let maxIterations = 100;
  let iterations = 0;

  while (itemsAdded && iterations < maxIterations) {
    itemsAdded = false;
    iterations++;

    const tnml = await getTNML(userId);

    // FIX 1: Bootstrap empty list (The "Chicken and Egg" fix)
    if (tnml === 0) {
      const sortedProjects = [...projects].sort((a, b) => b.priority - a.priority);

      let bootstrapped = false;
      for (const project of sortedProjects) {
        // PASS listId here
        const itemActivated = await activateNextProjectItem(userId, project.id, 0, listId);
        if (itemActivated) {
          itemsAdded = true;
          bootstrapped = true;
          break;
        }
      }

      if (!bootstrapped) break;
      else continue;
    }

    const { data: firstEntry } = await adminClient
      .from('master_list')
      .select('project_placeholder_id')
      .eq('user_id', userId)
      .eq('list_id', listId) // Filter by list ID
      .order('position', { ascending: true })
      .limit(1)
      .maybeSingle();

    if (firstEntry && firstEntry.project_placeholder_id) {
      const parts = firstEntry.project_placeholder_id.split('-');
      const projectId = parts.slice(0, -1).join('-');
      const { data: activeItems } = await adminClient
        .from('project_item_links')
        .select(`
          item_id,
          items!inner(id, status)
        `)
        .eq('project_item_links.project_id', projectId) // Disambiguate column
        .eq('items.status', 'Active')
        .limit(1);

      if (!activeItems || activeItems.length === 0) {
        // PASS listId here
        const itemActivated = await activateNextProjectItem(userId, projectId, tnml, listId);
        if (itemActivated) {
          itemsAdded = true;
          continue;
        }
      }
    }

    for (const project of projects) {
      // PASS listId here
      const wasItemAdded = await pingProjectForItem(userId, project.id, tnml, listId);
      if (wasItemAdded) {
        itemsAdded = true;
      }
    }
  }
}

export async function pingProjectForItem(
  userId: string,
  projectId: string,
  tnml: number,
  listId: string // ADDED parameter
): Promise<boolean> {
  const adminClient = createAdminClient();

  const plpi = await getPLPI(userId, projectId);

  const { data: project } = await adminClient
    .from('projects')
    .select('priority')
    .eq('id', projectId)
    .single();

  if (!project) {
    return false;
  }

  const pit = 1 / project.priority;

  let prs: number;
  if (plpi === 0) {
    prs = 1.0;
  } else if (tnml === 0) {
    return false;
  } else {
    prs = 1 - (plpi / tnml);
  }

  if (prs > pit) {
    // PASS listId here
    const itemAdded = await activateNextProjectItem(userId, projectId, tnml, listId);
    return itemAdded;
  }

  return false;
}

async function activateNextProjectItem(
  userId: string,
  projectId: string,
  currentTNML: number,
  listId: string // ADDED parameter
): Promise<boolean> {
  const adminClient = createAdminClient();

  try {
    const nextItem = await getNextInactiveProjectItem(projectId);

    if (!nextItem) {
      return false;
    }

    const { data: updateResult } = await adminClient
      .from('items')
      .update({ status: 'Active' })
      .eq('id', nextItem)
      .select('*');

    if (!updateResult || updateResult.length === 0) {
      return false;
    }

    const { data: existingPlaceholders } = await adminClient
      .from('master_list')
      .select('project_placeholder_id')
      .eq('user_id', userId)
      .eq('list_id', listId) // Filter by list ID
      .not('project_placeholder_id', 'is', null);

    let nextIndex = 1;
    if (existingPlaceholders && existingPlaceholders.length > 0) {
      for (const p of existingPlaceholders) {
        if (p.project_placeholder_id) {
          const parts = p.project_placeholder_id.split('-');
          const extractedProjectId = parts.slice(0, -1).join('-');
          const index = parseInt(parts[parts.length - 1]);

          if (extractedProjectId === projectId && !isNaN(index) && index >= nextIndex) {
            nextIndex = index + 1;
          }
        }
      }
    }

    const newPlaceholderId = `${projectId}-${nextIndex}`;

    // FIX 2: Correctly calculate position within the specific list
    const { data: maxPosition } = await adminClient
      .from('master_list')
      .select('position')
      .eq('user_id', userId)
      .eq('list_id', listId) // Filter by list ID
      .order('position', { ascending: false })
      .limit(1)
      .maybeSingle();

    const nextPosition = (maxPosition?.position || 0) + 1;

    // FIX 3: Include list_id in the insert
    const { data: insertResult, error } = await adminClient
      .from('master_list')
      .insert({
        user_id: userId,
        list_id: listId, // <-- THIS WAS MISSING
        position: nextPosition,
        item_id: null,
        project_placeholder_id: newPlaceholderId
      })
      .select();

    if (error) {
      console.error("Error inserting into master_list:", error);
      return false;
    }

    if (!insertResult || insertResult.length === 0) {
      return false;
    }

    return true;
  } catch (error) {
    console.error("Exception in activateNextProjectItem:", error);
    return false;
  }
}
</file>

</files>
